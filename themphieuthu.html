<!DOCTYPE html>
<html lang="vi" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Quản lý phiếu thu - Hệ thống quản lý phiếu thu đơn hàng hiệu quả">
    <meta name="theme-color" content="#0ea5e9">
    <title>Quản lý Phiếu Thu</title>

    <!-- Preconnect để cải thiện thời gian tải -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'pulse': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-in': 'bounceIn 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        pulse: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '.5' },
                        },
                        bounceIn: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '50%': { transform: 'scale(1.03)', opacity: '1' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                    },
                    width: {
                        '3/10': '30%',
                        '7/10': '70%',
                    }
                },
            },
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            @apply bg-gray-100 dark:bg-gray-700;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            @apply bg-gray-400 dark:bg-gray-500;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            @apply bg-gray-500 dark:bg-gray-400;
        }

        /* Card hover effect */
        .hover-card {
            transition: all 0.3s ease;
        }

        .hover-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Input focus */
        .custom-input:focus {
            outline: none;
            @apply border-primary-500 ring-2 ring-primary-200;
        }

        .animate-fade-out {
            animation: fadeOut 0.3s ease-out;
            opacity: 0;
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        /* Dark mode styles */
        .dark .hover-card {
            @apply bg-gray-800 text-white;
        }

        .dark .hover-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
        }

        /* Order item hover */
        .order-item {
            transition: all 0.2s ease-in-out;
        }

        .order-item:hover {
            @apply bg-gray-50 dark:bg-gray-700;
        }

        .order-item.selected {
            @apply bg-blue-50 dark:bg-blue-900/30 border-l-4 border-blue-500;
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 min-h-screen transition-colors duration-300">
    <!-- Loading Overlay -->
    <div id="loadingOverlay"
        class="fixed inset-0 bg-gray-800/70 dark:bg-black/80 backdrop-blur-sm z-50 flex justify-center items-center hidden transition-opacity duration-300">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl flex flex-col items-center animate-slide-up">
            <div class="animate-spin text-primary-600 dark:text-primary-400 mb-4">
                <i class="fas fa-circle-notch text-5xl"></i>
            </div>
            <p class="text-gray-700 dark:text-gray-100 font-medium text-lg" id="loadingText">Đang xử lý...</p>
        </div>
    </div>

    <!-- Page Container -->
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <header class="sticky top-0 z-30 bg-white dark:bg-gray-800 shadow-md rounded-xl px-4 py-3 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                <div class="flex items-center space-x-3">
                    <div class="bg-primary-600 text-white p-2.5 rounded-lg shadow-lg">
                        <i class="fas fa-file-invoice-dollar text-xl"></i>
                    </div>
                    <h1 class="text-xl md:text-2xl font-bold text-gray-800 dark:text-white">Quản lý Phiếu Thu</h1>
                </div>
                <div class="flex items-center mt-3 sm:mt-0">
                    <a href="index.html"
                        class="p-2 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors mr-2"
                        title="Quay lại trang chủ">
                        <i class="fas fa-home text-primary-600 dark:text-primary-400"></i>
                    </a>
                    <button id="refreshDataBtn"
                        class="p-2 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors mr-2"
                        title="Làm mới dữ liệu">
                        <i class="fas fa-sync-alt text-primary-600 dark:text-primary-400"></i>
                    </button>
                    <button id="darkModeToggle"
                        class="p-2 bg-gray-100 dark:bg-gray-700 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                        title="Chuyển đổi giao diện">
                        <i class="fas fa-moon text-gray-600 dark:hidden"></i>
                        <i class="fas fa-sun text-yellow-400 hidden dark:block"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex flex-col lg:flex-row gap-5">
            <!-- Left Column - Orders List (30%) -->
            <div class="lg:w-3/10 w-full">
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md hover-card animate-fade-in">
                    <div
                        class="flex items-center justify-between mb-4 border-b border-gray-200 dark:border-gray-700 pb-3">
                        <div class="flex items-center">
                            <div
                                class="bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 p-2 rounded-lg mr-3">
                                <i class="fas fa-shopping-cart text-xl"></i>
                            </div>
                            <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Danh Sách Đơn Hàng</h2>
                        </div>
                        <div class="relative w-full max-w-[200px]">
                            <input type="text" id="searchDonHangInput" placeholder="Tìm kiếm..."
                                class="w-full pl-8 pr-2 py-1.5 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-700 dark:text-white">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none">
                                <i class="fas fa-search text-gray-400 text-xs"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Date filter section - Thiết kế lại -->
                    <!-- Date filter section - Thiết kế mới -->
                    <div id="dateFilterSection"
                        class="mb-4 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                        <div class="flex flex-col space-y-3">
                            <div class="flex items-center justify-between">
                                <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300">Lọc theo khoảng thời
                                    gian</h3>
                                <button id="toggleAdvancedFilter"
                                    class="text-primary-600 dark:text-primary-400 text-xs hover:underline focus:outline-none">
                                    <i class="fas fa-sliders-h mr-1"></i> Tùy chọn
                                </button>
                            
                            <div class="flex space-x-2">
                                <button id="applyDateFilterBtn"
                                    class="px-4 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition flex-1 flex items-center justify-center">
                                    <i class="fas fa-filter"></i>
                                </button>
                                <button id="resetDateFilterBtn"
                                    class="p-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                                    <i class="fas fa-undo-alt"></i>
                                </button>
                            </div>
                        </div>

                            <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
                                <div class="md:col-span-2">
                                    <label class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1 block">Từ
                                        ngày:</label>
                                    <div class="relative">
                                        <input type="date" id="filterStartDate"
                                            class="w-full text-sm py-2 px-3 pr-8 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                        <div
                                            class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                            <i class="fas fa-calendar-alt text-gray-400 dark:text-gray-500"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="md:col-span-2">
                                    <label class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1 block">Đến
                                        ngày:</label>
                                    <div class="relative">
                                        <input type="date" id="filterEndDate"
                                            class="w-full text-sm py-2 px-3 pr-8 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                        <div
                                            class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                            <i class="fas fa-calendar-alt text-gray-400 dark:text-gray-500"></i>
                                        </div>
                                    </div>
                                </div>

                                
                            </div>

                            <!-- Phần lọc nâng cao (ẩn mặc định) -->
                            <div id="advancedFilterOptions"
                                class="hidden pt-2 border-t border-gray-200 dark:border-gray-700">
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-2">
                                    <div>
                                        <button id="filterToday"
                                            class="w-full px-1 py-1.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                                            Hôm nay
                                        </button>
                                    </div>
                                    <div>
                                        <button id="filterYesterday"
                                            class="w-full px-1 py-1.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                                            Hôm qua
                                        </button>
                                    </div>
                                    <div>
                                        <button id="filterThisWeek"
                                            class="w-full px-1 py-1.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                                            Tuần này
                                        </button>
                                    </div>
                                    <div>
                                        <button id="filterThisMonth"
                                            class="w-full px-1 py-1.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                                            Tháng này
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Skeleton loading -->
                    <div id="donHangSkeletonLoading" class="animate-pulse">
                        <div class="h-16 bg-gray-200 dark:bg-gray-700 rounded-lg mb-2"></div>
                        <div class="h-16 bg-gray-100 dark:bg-gray-800 mb-2"></div>
                        <div class="h-16 bg-gray-100 dark:bg-gray-800 mb-2"></div>
                        <div class="h-16 bg-gray-100 dark:bg-gray-800 mb-2"></div>
                        <div class="h-16 bg-gray-100 dark:bg-gray-800 rounded-lg"></div>
                    </div>

                    <!-- Orders List -->
                    <div id="donHangList" class="hidden">
                        <div class="overflow-auto max-h-[calc(100vh-240px)]">
                            <ul id="donHangListContainer" class="divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Orders will be inserted here by JS -->
                            </ul>
                        </div>

                        <!-- Pagination for orders -->
                        <div id="donHangPagination"
                            class="flex justify-between items-center mt-3 px-2 py-2 text-xs bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <button id="prevPageDonHang"
                                class="p-1.5 bg-gray-200 dark:bg-gray-600 rounded hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span class="text-gray-700 dark:text-gray-300">
                                <span id="currentPageDonHang">1</span>/<span id="totalPagesDonHang">1</span>
                            </span>
                            <button id="nextPageDonHang"
                                class="p-1.5 bg-gray-200 dark:bg-gray-600 rounded hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Receipt Form & List (70%) -->
            <div class="lg:w-7/10 w-full">
                <!-- Selected order info header -->
                <div id="selectedOrderInfo"
                    class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md mb-4 hover-card animate-fade-in hidden">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                        <div class="mb-2 sm:mb-0">
                            <h3 class="font-medium text-gray-800 dark:text-white" id="donHangSelectedInfo">Đơn hàng:
                                Chưa chọn</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400" id="khachHangSelectedInfo">Khách hàng: -
                            </p>
                        </div>
                        <div class="flex items-center">
                            <span class="text-sm font-medium text-gray-600 dark:text-gray-400 mr-2">Tổng tiền:</span>
                            <span
                                class="bg-blue-100 dark:bg-blue-800 px-3 py-1 rounded-full text-blue-800 dark:text-blue-200 font-medium"
                                id="tongTienDonHang">0 đ</span>
                        </div>
                    </div>
                </div>

                <!-- Receipt Form -->
                <div id="phieuThuFormContainer"
                    class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md mb-4 hover-card animate-fade-in hidden">
                    <div class="flex items-center mb-3 border-b border-gray-200 dark:border-gray-700 pb-2">
                        <div
                            class="bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 p-2 rounded-lg mr-3">
                            <i class="fas fa-receipt text-lg"></i>
                        </div>
                        <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Thông Tin Phiếu Thu</h2>
                    </div>

                    <form id="phieuThuForm" class="mx-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                        <!-- ID phiếu thu và ID đơn hàng -->
                        <input type="hidden" id="idPhieuThu">
                        <input type="hidden" id="idDonHang">

                        <!-- Số tiền tạm ứng -->
                        <div class="form-group">
                            <label class="text-xs font-medium text-gray-600 dark:text-gray-300 mb-1 block">Số tiền tạm
                                ứng
                                <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <i
                                    class="fas fa-coins absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                                <input type="number" id="soTienTamUng" min="0" step="1000"
                                    class="w-full text-sm pl-7 pr-2 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white custom-input"
                                    required>
                            </div>
                        </div>

                        <!-- Ngày tạm ứng -->
                        <div class="form-group">
                            <label class="text-xs font-medium text-gray-600 dark:text-gray-300 mb-1 block">Ngày tạm ứng
                                <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <i
                                    class="fas fa-calendar-alt absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                                <input type="date" id="ngayTamUng"
                                    class="w-full text-sm pl-7 pr-2 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 dark:text-white custom-input"
                                    required>
                            </div>
                        </div>

                        <!-- Phương thức thanh toán -->
                        <div class="form-group">
                            <label class="text-xs font-medium text-gray-600 dark:text-gray-300 mb-1 block">Phương thức
                                thanh
                                toán <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <i
                                    class="fas fa-credit-card absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                                <select id="phuongThucThanhToan"
                                    class="w-full text-sm pl-7 pr-8 py-2 border border-gray-300 dark:border-gray-600 rounded appearance-none bg-white dark:bg-gray-700 dark:text-white custom-input"
                                    required>
                                    <option value="">-- Chọn phương thức --</option>
                                    <option value="MB">MB Ngân hàng Quân Đội (MB Bank) - CN Gia Lâm. STK: 6666.939.8888
                                        - Đỗ
                                        Trọng Nghĩa</option>
                                    <option value="VP">VP Ngân hàng VPBank - CN Thăng Long. STK: 156939258 - Công ty
                                        TNHH
                                        Sản xuất và Dịch vụ Đức Thành (DUC THANH SERPRO)</option>
                                    <option value="Grab">Grab</option>
                                </select>
                                <i
                                    class="fas fa-chevron-down absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                            </div>
                        </div>

                        <!-- Ghi chú -->
                        <div class="form-group sm:col-span-2">
                            <label class="text-xs font-medium text-gray-600 dark:text-gray-300 mb-1 block">Ghi
                                chú</label>
                            <div class="relative">
                                <i class="fas fa-sticky-note absolute left-2 top-2 text-gray-400 text-xs"></i>
                                <textarea id="ghiChuPhieuThu"
                                    class="w-full text-sm pl-7 pr-2 py-2 border border-gray-300 dark:border-gray-600 rounded resize-none bg-white dark:bg-gray-700 dark:text-white custom-input"
                                    rows="1"></textarea>
                            </div>
                        </div>

                        <!-- Ghi chú kế toán -->
                        <div class="form-group">
                            <label class="text-xs font-medium text-gray-600 dark:text-gray-300 mb-1 block">Ghi chú kế
                                toán</label>
                            <div class="relative">
                                <i class="fas fa-calculator absolute left-2 top-2 text-gray-400 text-xs"></i>
                                <textarea id="ghiChuKeToan"
                                    class="w-full text-sm pl-7 pr-2 py-2 border border-gray-300 dark:border-gray-600 rounded resize-none bg-white dark:bg-gray-700 dark:text-white custom-input"
                                    rows="1"></textarea>
                            </div>
                        </div>

                        <!-- Nút bấm -->
                        <div class="sm:col-span-3 flex justify-end space-x-2 mt-3">
                            <button type="button" id="huyPhieuThuBtn"
                                class="px-3 py-1.5 text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-200 rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition flex items-center shadow-sm">
                                <i class="fas fa-times mr-1"></i> Hủy
                            </button>
                            <button type="reset" id="resetPhieuThuFormBtn"
                                class="px-3 py-1.5 text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-200 rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition flex items-center shadow-sm">
                                <i class="fas fa-redo-alt mr-1"></i> Làm mới
                            </button>
                            <button type="submit"
                                class="px-3 py-1.5 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition flex items-center shadow-sm">
                                <i class="fas fa-save mr-1"></i> Lưu
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Receipt List -->
                <div id="phieuThuListContainer"
                    class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md hover-card animate-fade-in hidden">
                    <div
                        class="flex items-center justify-between mb-3 border-b border-gray-200 dark:border-gray-700 pb-2">
                        <div class="flex items-center">
                            <div
                                class="bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 p-2 rounded-lg mr-3">
                                <i class="fas fa-list-ul text-lg"></i>
                            </div>
                            <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Danh Sách Phiếu Thu</h2>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="importExcelBtn"
                                class="text-sm px-3 py-1.5 bg-blue-600 text-white rounded transition shadow-sm hover:bg-blue-700 flex items-center">
                                <i class="fas fa-file-import mr-1"></i> Nhập Excel
                            </button>
                            <button id="exportExcelBtn" onclick="createExcelTemplate()"
                                class="text-sm px-3 py-1.5 bg-green-600 text-white rounded transition shadow-sm hover:bg-green-700 flex items-center">
                                <i class="fas fa-file-export mr-1"></i> File mẫu
                            </button>
                            <button id="themPhieuThuBtn"
                                class="text-sm px-3 py-1.5 bg-green-600 text-white rounded transition shadow-sm hover:bg-green-700 flex items-center">
                                <i class="fas fa-plus mr-1"></i> Thêm
                            </button>
                            <input type="file" id="excelFileInput" accept=".xlsx, .xls, .csv" class="hidden">
                        </div>
                    </div>

                    <!-- Excel preview section -->
                    <div id="previewSection"
                        class="mt-3 mb-4 hidden bg-white dark:bg-gray-700 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                        <h3 class="text-md font-medium text-gray-800 dark:text-white mb-2">Xem trước dữ liệu (5 dòng đầu
                            tiên):</h3>
                        <div class="overflow-x-auto border rounded-lg dark:border-gray-700">
                            <table id="previewTable" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700"></thead>
                                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                </tbody>
                            </table>
                        </div>
                        <div class="flex justify-end space-x-3 mt-3">
                            <button id="cancelImportBtn"
                                class="px-3 py-1.5 text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                                Hủy
                            </button>
                            <button id="confirmImportBtn"
                                class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                                Nhập dữ liệu
                            </button>
                        </div>
                    </div>

                    <!-- Skeleton loading -->
                    <div id="phieuThuSkeletonLoading" class="animate-pulse">
                        <div class="h-12 bg-gray-200 dark:bg-gray-700 rounded-t-lg mb-1"></div>
                        <div class="h-16 bg-gray-100 dark:bg-gray-800 mb-1"></div>
                        <div class="h-16 bg-gray-100 dark:bg-gray-800 mb-1"></div>
                        <div class="h-16 bg-gray-100 dark:bg-gray-800 rounded-b-lg"></div>
                    </div>

                    <!-- Receipt table -->
                    <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700 hidden"
                        id="phieuThuTableContainer">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Mã phiếu
                                    </th>
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Ngày tạm ứng
                                    </th>
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Số tiền
                                    </th>
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        P.thức thanh toán
                                    </th>
                                    <th scope="col"
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Ghi chú
                                    </th>
                                    <th scope="col"
                                        class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                        Thao tác
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="phieuThuTableBody"
                                class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Dữ liệu sẽ được điền vào đây bằng JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Totals info -->
                    <div
                        class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4 mt-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center">
                            <span class="text-sm font-medium text-gray-600 dark:text-gray-400 mr-2">Tổng thu:</span>
                            <span
                                class="bg-green-100 dark:bg-green-800 px-3 py-1 rounded-full text-green-800 dark:text-green-200 font-medium"
                                id="tongThuPhieuThu">0 đ</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-sm font-medium text-gray-600 dark:text-gray-400 mr-2">Còn lại:</span>
                            <span
                                class="bg-yellow-100 dark:bg-yellow-800 px-3 py-1 rounded-full text-yellow-800 dark:text-yellow-200 font-medium"
                                id="conLaiPhieuThu">0 đ</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Floating Action Button -->
        <button id="scrollToTopBtn"
            class="fixed bottom-5 right-5 p-3 bg-primary-600 text-white rounded-full shadow-lg opacity-0 transition-opacity duration-300 hover:bg-primary-700 focus:outline-none">
            <i class="fas fa-arrow-up"></i>
        </button>
    </div>
    <script src="https://hoangmv.github.io/ducthanh/key.js"></script>
    <script>
        // Cấu hình API và các biến toàn cục
        let allDonHangList = []; // Tất cả đơn hàng
        let allPhieuThuList = []; // Tất cả phiếu thu
        let filteredDonHangList = []; // Đơn hàng đã lọc
        let currentPhieuThuList = []; // Phiếu thu của đơn hàng hiện tại
        let selectedDonHang = null; // Đơn hàng đang được chọn

        // Phân trang
        const ITEMS_PER_PAGE = 10;
        let currentPageDonHang = 1;

        // Hàm lấy thông tin từ URL
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                idNhanVien: params.get('idNV') || '',
                nguoiTao: params.get('user') || 'System'
            };
        }

        // Lưu thông tin từ URL
        let urlParams = getURLParams();

        // Hàm hiển thị và ẩn loading
        function showLoading(message = 'Đang xử lý...') {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // Hàm hiển thị và ẩn skeleton loading cho bảng đơn hàng
        function showDonHangSkeleton() {
            document.getElementById('donHangList').classList.add('hidden');
            document.getElementById('donHangSkeletonLoading').classList.remove('hidden');
        }

        function hideDonHangSkeleton() {
            document.getElementById('donHangList').classList.remove('hidden');
            document.getElementById('donHangSkeletonLoading').classList.add('hidden');
        }

        // Hàm hiển thị và ẩn skeleton loading cho bảng phiếu thu
        function showPhieuThuSkeleton() {
            document.getElementById('phieuThuTableContainer').classList.add('hidden');
            document.getElementById('phieuThuSkeletonLoading').classList.remove('hidden');
        }

        function hidePhieuThuSkeleton() {
            document.getElementById('phieuThuTableContainer').classList.remove('hidden');
            document.getElementById('phieuThuSkeletonLoading').classList.add('hidden');
        }

        // Hàm tạo mã phiếu thu tự động
        function generateMaPhieuThu() {
            const today = new Date();
            const year = today.getFullYear().toString().slice(-2);
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `PT${year}${month}${day}${random}`;
        }

        // Hàm định dạng tiền tệ
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        // Hàm định dạng ngày theo chuẩn yyyy-mm-dd
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');

            return `${year}-${month}-${day}`;
        }

        // Hàm format ngày hiển thị
        function formatDisplayDate(dateString) {
            if (!dateString) return '';

            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();

            return `${day}/${month}/${year}`;
        }

        // Hàm debounce để tránh gọi nhiều lần liên tiếp
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Xác định trạng thái thanh toán của đơn hàng để hiển thị màu phù hợp
        function getReceiptStatusClass(donHang) {
            // Tìm tất cả phiếu thu cho đơn hàng này
            const orderReceipts = allPhieuThuList.filter(pt => pt['ID đơn hàng'] === donHang['ID đơn hàng']);

            if (orderReceipts.length === 0) {
                return 'text-red-500 dark:text-red-400'; // Chưa có phiếu thu
            }

            // Tính tổng tiền đã thu
            let totalPaid = 0;
            orderReceipts.forEach(pt => {
                totalPaid += parseFloat(pt['Số tiền tạm ứng'] || 0);
            });

            const orderTotal = parseFloat(donHang['Tổng giá trị đơn'] || 0);

            if (totalPaid >= orderTotal) {
                return 'text-green-500 dark:text-green-400'; // Đã thanh toán đủ
            } else if (totalPaid > 0) {
                return 'text-yellow-600 dark:text-yellow-400'; // Thanh toán một phần
            } else {
                return 'text-red-500 dark:text-red-400'; // Chưa thanh toán
            }
        }



        // Lọc đơn hàng theo khoảng ngày
        // Lọc đơn hàng theo khoảng ngày
        function applyDateFilter() {
            const startDateValue = document.getElementById('filterStartDate').value;
            const endDateValue = document.getElementById('filterEndDate').value;

            showDonHangSkeleton();

            setTimeout(() => {
                // Nếu không có ngày được chọn, không lọc theo ngày
                if (!startDateValue && !endDateValue) {
                    filteredDonHangList = [...allDonHangList];
                } else {
                    // Chuyển đổi chuỗi ngày thành đối tượng Date
                    // Sử dụng startOfDay và endOfDay để bao quát cả ngày
                    let startDate = null;
                    let endDate = null;

                    if (startDateValue) {
                        startDate = new Date(startDateValue);
                        startDate.setHours(0, 0, 0, 0); // Đặt thời gian bắt đầu của ngày
                    }

                    if (endDateValue) {
                        endDate = new Date(endDateValue);
                        endDate.setHours(23, 59, 59, 999); // Đặt thời gian kết thúc của ngày
                    } else if (startDateValue && !endDateValue) {
                        // Nếu chỉ chọn ngày bắt đầu mà không chọn ngày kết thúc
                        // Sử dụng cùng ngày làm ngày kết thúc (lọc cho một ngày)
                        endDate = new Date(startDateValue);
                        endDate.setHours(23, 59, 59, 999);
                    }

                    if (!startDate) {
                        startDate = new Date(0); // Từ ngày xa xưa nếu không có ngày bắt đầu
                    }

                    if (!endDate) {
                        endDate = new Date(); // Đến ngày hiện tại nếu không có ngày kết thúc
                        endDate.setHours(23, 59, 59, 999);
                    }

                    filteredDonHangList = allDonHangList.filter(donHang => {
                        if (!donHang['Ngày đặt hàng']) return false;

                        const orderDate = new Date(donHang['Ngày đặt hàng']);
                        return orderDate >= startDate && orderDate <= endDate;
                    });
                }

                // Áp dụng từ khóa tìm kiếm nếu có
                const searchKeyword = document.getElementById('searchDonHangInput').value.trim().toLowerCase();
                if (searchKeyword) {
                    filteredDonHangList = filteredDonHangList.filter(donHang => {
                        const maDH = (donHang['Mã đơn hàng'] || '').toLowerCase();
                        const tenDH = (donHang['Tên đơn hàng'] || '').toLowerCase();
                        const tenKH = (donHang['Tên khách hàng'] || '').toLowerCase();
                        const ngayDH = donHang['Ngày đặt hàng'] ? formatDisplayDate(donHang['Ngày đặt hàng']).toLowerCase() : '';

                        return maDH.includes(searchKeyword) ||
                            tenDH.includes(searchKeyword) ||
                            tenKH.includes(searchKeyword) ||
                            ngayDH.includes(searchKeyword);
                    });
                }

                currentPageDonHang = 1; // Reset về trang đầu sau khi lọc
                renderDonHangList();

                // Thêm thông báo kết quả tìm kiếm
                const resultCount = filteredDonHangList.length;
                if (resultCount === 0) {
                    Swal.fire({
                        icon: 'info',
                        title: 'Không tìm thấy kết quả',
                        text: 'Không có đơn hàng nào phù hợp với điều kiện lọc',
                        confirmButtonColor: '#0ea5e9',
                        timer: 3000,
                        timerProgressBar: true
                    });
                }
            }, 300);
        }

        // Reset bộ lọc ngày
        function resetDateFilter() {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('searchDonHangInput').value = '';

            showDonHangSkeleton();

            setTimeout(() => {
                filteredDonHangList = [...allDonHangList];
                currentPageDonHang = 1;
                renderDonHangList();
            }, 300);
        }

        // Sửa lại hàm tải dữ liệu để sắp xếp đơn hàng theo ngày mới nhất
        async function loadAllData(forceRefresh = false) {
            try {
                showLoading('Đang tải dữ liệu...');

                // Gọi song song các API để tối ưu thời gian
                const [donHangResponse, phieuThuResponse] = await Promise.all([
                    axios({
                        method: 'POST',
                        url: `https://www.appsheet.com/api/v2/apps/${appId}/tables/Đơn hàng/Action`,
                        headers: {
                            'ApplicationAccessKey': accessKey,
                            'Content-Type': 'application/json'
                        },
                        data: {
                            "Action": "Find",
                            "Properties": {
                                "Locale": "vi-VN",
                                "Timezone": "Asia/Ho_Chi_Minh",
                                "Selector": "Filter(Đơn hàng, [Thùng rác] <> TRUE())"
                            }
                        }
                    }),
                    axios({
                        method: 'POST',
                        url: `https://www.appsheet.com/api/v2/apps/${appId}/tables/Phiếu thu/Action`,
                        headers: {
                            'ApplicationAccessKey': accessKey,
                            'Content-Type': 'application/json'
                        },
                        data: {
                            "Action": "Find",
                            "Properties": {
                                "Locale": "vi-VN",
                                "Timezone": "Asia/Ho_Chi_Minh"
                            }
                        }
                    })
                ]);

                // Xử lý dữ liệu đơn hàng
                if (donHangResponse.data && donHangResponse.data.Rows) {
                    allDonHangList = donHangResponse.data.Rows;
                } else if (Array.isArray(donHangResponse.data)) {
                    allDonHangList = donHangResponse.data;
                } else {
                    console.error('Cấu trúc dữ liệu đơn hàng không đúng:', donHangResponse.data);
                    allDonHangList = [];
                }

                // Sắp xếp danh sách đơn hàng theo ngày mới nhất
                allDonHangList.sort((a, b) => {
                    const dateA = a['Ngày đặt hàng'] ? new Date(a['Ngày đặt hàng']) : new Date(0);
                    const dateB = b['Ngày đặt hàng'] ? new Date(b['Ngày đặt hàng']) : new Date(0);
                    return dateB - dateA; // Sắp xếp giảm dần (mới nhất lên đầu)
                });

                // Cập nhật danh sách đơn hàng đã lọc và hiển thị
                filteredDonHangList = [...allDonHangList];

                // Xử lý dữ liệu phiếu thu
                if (phieuThuResponse.data && phieuThuResponse.data.Rows) {
                    allPhieuThuList = phieuThuResponse.data.Rows;
                } else if (Array.isArray(phieuThuResponse.data)) {
                    allPhieuThuList = phieuThuResponse.data;
                } else {
                    console.error('Cấu trúc dữ liệu phiếu thu không đúng:', phieuThuResponse.data);
                    allPhieuThuList = [];
                }

                // Hiển thị danh sách đơn hàng
                renderDonHangList();

                hideLoading();
                return true;
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
                hideLoading();

                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi kết nối',
                    text: 'Không thể tải dữ liệu. Vui lòng thử lại sau.',
                    confirmButtonColor: '#0ea5e9'
                });

                return false;
            }
        }

        // Hàm hiển thị danh sách đơn hàng với thiết kế mới
        function renderDonHangList() {
            const listContainer = document.getElementById('donHangListContainer');
            listContainer.innerHTML = '';

            if (filteredDonHangList.length === 0) {
                listContainer.innerHTML = `
               <li class="py-3 px-2 text-center text-sm text-gray-500 dark:text-gray-400">
                   Không có dữ liệu đơn hàng
               </li>
           `;
                document.getElementById('donHangPagination').classList.add('hidden');
                return;
            }

            const start = (currentPageDonHang - 1) * ITEMS_PER_PAGE;
            const end = Math.min(start + ITEMS_PER_PAGE, filteredDonHangList.length);

            // Tạo danh sách đơn hàng
            for (let i = start; i < end; i++) {
                const donHang = filteredDonHangList[i];
                const li = document.createElement('li');
                li.className = 'order-item py-3 px-2 hover:bg-gray-50 dark:hover:bg-gray-700 rounded transition-colors cursor-pointer';

                // Thêm class selected nếu đơn hàng này đang được chọn
                if (selectedDonHang && donHang['ID đơn hàng'] === selectedDonHang['ID đơn hàng']) {
                    li.classList.add('selected');
                }

                const ngayDatHang = donHang['Ngày đặt hàng'] ? formatDisplayDate(donHang['Ngày đặt hàng']) : 'N/A';
                const tongTien = donHang['Tổng giá trị đơn'] ? formatCurrency(donHang['Tổng giá trị đơn']) : formatCurrency(0);

                li.innerHTML = `
               <div class="flex flex-col">
                   <div class="flex justify-between items-center">
                       <span class="font-medium text-sm text-gray-900 dark:text-white">${donHang['Mã đơn hàng'] || ''}</span>
                       <span class="text-xs text-gray-500 dark:text-gray-400">${ngayDatHang}</span>
                   </div>
                   <p class="text-sm text-gray-700 dark:text-gray-300 truncate">${donHang['Tên đơn hàng'] || ''}</p>
                   <div class="flex justify-between items-center mt-1">
                       <span class="text-xs text-gray-500 dark:text-gray-400">${donHang['Tên khách hàng'] || ''}</span>
                       <span class="text-xs font-medium ${getReceiptStatusClass(donHang)}">${tongTien}</span>
                   </div>
               </div>
           `;

                // Thêm sự kiện click để chọn đơn hàng này
                li.addEventListener('click', () => viewPhieuThu(donHang['ID đơn hàng']));

                listContainer.appendChild(li);
            }

            // Hiển thị danh sách đơn hàng và cập nhật phân trang
            hideDonHangSkeleton();
            updateDonHangPagination();
        }

        // Hàm cập nhật phân trang đơn hàng
        function updateDonHangPagination() {
            const totalPages = Math.ceil(filteredDonHangList.length / ITEMS_PER_PAGE);
            const paginationElement = document.getElementById('donHangPagination');

            if (totalPages <= 1) {
                paginationElement.classList.add('hidden');
                return;
            } else {
                paginationElement.classList.remove('hidden');
            }

            // Cập nhật thông tin trang hiện tại
            document.getElementById('currentPageDonHang').textContent = currentPageDonHang;
            document.getElementById('totalPagesDonHang').textContent = totalPages;

            // Cập nhật trạng thái nút Previous/Next
            const prevBtn = document.getElementById('prevPageDonHang');
            const nextBtn = document.getElementById('nextPageDonHang');

            prevBtn.disabled = currentPageDonHang === 1;
            nextBtn.disabled = currentPageDonHang === totalPages;

            if (prevBtn.disabled) {
                prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            if (nextBtn.disabled) {
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Hàm xem phiếu thu của đơn hàng
        function viewPhieuThu(idDonHang) {
            // Tìm đơn hàng trong dữ liệu đã lưu
            selectedDonHang = allDonHangList.find(dh => dh['ID đơn hàng'] === idDonHang);

            if (!selectedDonHang) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Không tìm thấy thông tin đơn hàng',
                    confirmButtonColor: '#0ea5e9'
                });
                return;
            }

            // Cập nhật thông tin đơn hàng đang xem
            document.getElementById('selectedOrderInfo').classList.remove('hidden');
            document.getElementById('donHangSelectedInfo').textContent = `Đơn hàng: ${selectedDonHang['Tên đơn hàng'] || 'N/A'} (${selectedDonHang['Mã đơn hàng'] || 'N/A'})`;
            document.getElementById('khachHangSelectedInfo').textContent = `Khách hàng: ${selectedDonHang['Tên khách hàng'] || 'N/A'}`;
            document.getElementById('tongTienDonHang').textContent = formatCurrency(selectedDonHang['Tổng giá trị đơn'] || 0);

            // Lọc phiếu thu cho đơn hàng này từ dữ liệu đã lưu
            currentPhieuThuList = allPhieuThuList.filter(pt => pt['ID đơn hàng'] === idDonHang);

            // Hiển thị container phiếu thu
            document.getElementById('phieuThuListContainer').classList.remove('hidden');
            document.getElementById('phieuThuFormContainer').classList.add('hidden');

            // Reset form phiếu thu
            document.getElementById('idDonHang').value = idDonHang;
            document.getElementById('phieuThuForm').reset();
            document.getElementById('ngayTamUng').value = formatDate(new Date());

            // Hiển thị danh sách phiếu thu
            renderPhieuThuList();

            // Cập nhật tổng thu và số tiền còn lại
            updateTongThuVaConLai();

            // Cập nhật lại danh sách đơn hàng để hiển thị đơn hàng được chọn
            renderDonHangList();
        }

        // Hàm hiển thị danh sách phiếu thu
        function renderPhieuThuList() {
            const tableBody = document.getElementById('phieuThuTableBody');
            tableBody.innerHTML = '';

            if (currentPhieuThuList.length === 0) {
                tableBody.innerHTML = `
               <tr>
                   <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                       Chưa có phiếu thu nào cho đơn hàng này
                   </td>
               </tr>
           `;
                return;
            }

            // Sắp xếp phiếu thu theo ngày tạm ứng (mới nhất lên đầu)
            const sortedPhieuThu = [...currentPhieuThuList].sort((a, b) => {
                const dateA = a['Ngày tạm ứng'] ? new Date(a['Ngày tạm ứng']) : new Date(0);
                const dateB = b['Ngày tạm ứng'] ? new Date(b['Ngày tạm ứng']) : new Date(0);
                return dateB - dateA;
            });

            // Hiển thị danh sách phiếu thu
            sortedPhieuThu.forEach(phieuThu => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors';

                // Format ngày tạm ứng
                const ngayTamUng = phieuThu['Ngày tạm ứng'] ? formatDisplayDate(phieuThu['Ngày tạm ứng']) : 'N/A';

                // Format số tiền tạm ứng
                const soTienTamUng = phieuThu['Số tiền tạm ứng'] ? formatCurrency(phieuThu['Số tiền tạm ứng']) : formatCurrency(0);

                row.innerHTML = `
               <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                   ${phieuThu['ID phiếu thu'] || ''}
               </td>
               <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">
                   ${ngayTamUng}
               </td>
               <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 dark:text-green-400 font-medium">
                   ${soTienTamUng}
               </td>
               <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                   ${phieuThu['Phương thức thanh toán'] || ''}
               </td>
               <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 max-w-xs truncate">
                   ${phieuThu['Ghi chú'] || ''}
               </td>
               <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                   <button onclick="editPhieuThu('${phieuThu['ID phiếu thu'] || ''}')" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300 mr-3 transition-colors">
                       <i class="fas fa-edit"></i>
                   </button>
                   <button onclick="deletePhieuThu('${phieuThu['ID phiếu thu'] || ''}')" class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 transition-colors">
                       <i class="fas fa-trash-alt"></i>
                   </button>
               </td>
           `;

                tableBody.appendChild(row);
            });

            // Hiển thị bảng phiếu thu
            hidePhieuThuSkeleton();
        }

        // Hàm cập nhật tổng thu và số tiền còn lại
        function updateTongThuVaConLai() {
            if (!selectedDonHang) return;

            // Tính tổng tiền đã thu
            let tongThu = 0;
            currentPhieuThuList.forEach(phieuThu => {
                tongThu += parseFloat(phieuThu['Số tiền tạm ứng'] || 0);
            });

            // Lấy tổng giá trị đơn hàng
            const tongGiaTriDon = parseFloat(selectedDonHang['Tổng giá trị đơn'] || 0);

            // Tính số tiền còn lại
            const conLai = tongGiaTriDon - tongThu;

            // Cập nhật hiển thị
            document.getElementById('tongThuPhieuThu').textContent = formatCurrency(tongThu);
            document.getElementById('conLaiPhieuThu').textContent = formatCurrency(conLai);

            // Đổi màu nếu đã thu đủ hoặc thừa
            const conLaiElement = document.getElementById('conLaiPhieuThu');
            if (conLai <= 0) {
                conLaiElement.classList.remove('bg-yellow-100', 'dark:bg-yellow-800', 'text-yellow-800', 'dark:text-yellow-200');
                conLaiElement.classList.add('bg-green-100', 'dark:bg-green-800', 'text-green-800', 'dark:text-green-200');
            } else {
                conLaiElement.classList.remove('bg-green-100', 'dark:bg-green-800', 'text-green-800', 'dark:text-green-200');
                conLaiElement.classList.add('bg-yellow-100', 'dark:bg-yellow-800', 'text-yellow-800', 'dark:text-yellow-200');
            }
        }

        // Hàm làm mới form phiếu thu
        function resetPhieuThuForm() {
            document.getElementById('phieuThuForm').reset();
            document.getElementById('idPhieuThu').value = '';
            document.getElementById('idDonHang').value = selectedDonHang ? selectedDonHang['ID đơn hàng'] : '';

            // Set ngày mặc định là hôm nay
            document.getElementById('ngayTamUng').value = formatDate(new Date());
        }

        // Hàm mở form thêm phiếu thu mới
        function showAddPhieuThuForm() {
            if (!selectedDonHang) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Lưu ý',
                    text: 'Vui lòng chọn đơn hàng trước khi thêm phiếu thu',
                    confirmButtonColor: '#0ea5e9'
                });
                return;
            }

            resetPhieuThuForm();
            document.getElementById('phieuThuFormContainer').classList.remove('hidden');
        }

        // Hàm chỉnh sửa phiếu thu
        function editPhieuThu(idPhieuThu) {
            const phieuThu = allPhieuThuList.find(pt => pt['ID phiếu thu'] === idPhieuThu);

            if (!phieuThu) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Không tìm thấy thông tin phiếu thu',
                    confirmButtonColor: '#0ea5e9'
                });
                return;
            }

            // Điền thông tin vào form
            document.getElementById('idPhieuThu').value = phieuThu['ID phiếu thu'];
            document.getElementById('idDonHang').value = phieuThu['ID đơn hàng'];
            document.getElementById('soTienTamUng').value = phieuThu['Số tiền tạm ứng'] || 0;
            document.getElementById('ngayTamUng').value = phieuThu['Ngày tạm ứng'] ? formatDate(new Date(phieuThu['Ngày tạm ứng'])) : formatDate(new Date());
            document.getElementById('phuongThucThanhToan').value = phieuThu['Phương thức thanh toán'] || '';
            document.getElementById('ghiChuPhieuThu').value = phieuThu['Ghi chú'] || '';
            document.getElementById('ghiChuKeToan').value = phieuThu['Ghi chú kế toán'] || '';

            // Hiển thị form
            document.getElementById('phieuThuFormContainer').classList.remove('hidden');
        }

        // Hàm xóa phiếu thu
        async function deletePhieuThu(idPhieuThu) {
            Swal.fire({
                title: 'Xác nhận xóa',
                text: 'Bạn có chắc chắn muốn xóa phiếu thu này không?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        showLoading('Đang xóa phiếu thu...');

                        // Gọi API để xóa phiếu thu
                        await axios({
                            method: 'POST',
                            url: `https://www.appsheet.com/api/v2/apps/${appId}/tables/Phiếu thu/Action`,
                            headers: {
                                'ApplicationAccessKey': accessKey,
                                'Content-Type': 'application/json'
                            },
                            data: {
                                "Action": "Delete",
                                "Properties": {
                                    "Locale": "vi-VN",
                                    "Timezone": "Asia/Ho_Chi_Minh"
                                },
                                "Rows": [
                                    { "ID phiếu thu": idPhieuThu }
                                ]
                            }
                        });

                        // Cập nhật dữ liệu local sau khi xóa thành công
                        allPhieuThuList = allPhieuThuList.filter(pt => pt['ID phiếu thu'] !== idPhieuThu);
                        currentPhieuThuList = currentPhieuThuList.filter(pt => pt['ID phiếu thu'] !== idPhieuThu);

                        // Hiển thị lại danh sách phiếu thu
                        renderPhieuThuList();
                        updateTongThuVaConLai();

                        // Cập nhật lại danh sách đơn hàng để hiển thị trạng thái thanh toán mới
                        renderDonHangList();

                        hideLoading();

                        Swal.fire({
                            icon: 'success',
                            title: 'Đã xóa',
                            text: 'Phiếu thu đã được xóa thành công',
                            confirmButtonColor: '#0ea5e9',
                            timer: 1500,
                            timerProgressBar: true
                        });
                    } catch (error) {
                        console.error('Lỗi khi xóa phiếu thu:', error);
                        hideLoading();

                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi',
                            text: 'Không thể xóa phiếu thu. Vui lòng thử lại sau.',
                            confirmButtonColor: '#d33'
                        });
                    }
                }
            });
        }

        // Hàm lưu phiếu thu
        async function savePhieuThu(event) {
            event.preventDefault();

            // Lấy dữ liệu từ form
            const idPhieuThu = document.getElementById('idPhieuThu').value || generateMaPhieuThu();
            const idDonHang = document.getElementById('idDonHang').value;
            const soTienTamUng = document.getElementById('soTienTamUng').value.trim();
            const ngayTamUng = document.getElementById('ngayTamUng').value;
            const phuongThucThanhToan = document.getElementById('phuongThucThanhToan').value;

            // Kiểm tra dữ liệu bắt buộc
            if (!soTienTamUng || !ngayTamUng || !phuongThucThanhToan) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Thiếu thông tin',
                    text: 'Vui lòng điền đầy đủ số tiền, ngày tạm ứng và phương thức thanh toán',
                    confirmButtonColor: '#0ea5e9'
                });
                return;
            }

            try {
                showLoading('Đang lưu thông tin phiếu thu...');

                // Chuẩn bị dữ liệu
                const phieuThuData = {
                    'ID phiếu thu': idPhieuThu,
                    'ID đơn hàng': idDonHang,
                    'ID nhân viên': urlParams.idNhanVien,
                    'Số tiền tạm ứng': parseFloat(soTienTamUng),
                    'Ngày tạm ứng': ngayTamUng,
                    'Phương thức thanh toán': phuongThucThanhToan,
                    'Ghi chú': document.getElementById('ghiChuPhieuThu').value.trim(),
                    'Ghi chú kế toán': document.getElementById('ghiChuKeToan').value.trim(),
                    'Người tạo': urlParams.nguoiTao,
                    'Ngày tạo': formatDate(new Date())
                };

                // Kiểm tra xem là thêm mới hay cập nhật
                const existingIndex = allPhieuThuList.findIndex(pt => pt['ID phiếu thu'] === idPhieuThu);
                const action = existingIndex >= 0 ? "Edit" : "Add";

                // Gọi API để lưu thông tin
                await axios({
                    method: 'POST',
                    url: `https://www.appsheet.com/api/v2/apps/${appId}/tables/Phiếu thu/Action`,
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    data: {
                        "Action": action,
                        "Properties": {
                            "Locale": "vi-VN",
                            "Timezone": "Asia/Ho_Chi_Minh"
                        },
                        "Rows": [phieuThuData]
                    }
                });

                // Cập nhật dữ liệu local
                if (action === "Add") {
                    allPhieuThuList.push(phieuThuData);
                    currentPhieuThuList.push(phieuThuData);
                } else {
                    // Cập nhật trong danh sách toàn bộ phiếu thu
                    allPhieuThuList[existingIndex] = phieuThuData;

                    // Cập nhật trong danh sách phiếu thu hiện tại
                    const currentIndex = currentPhieuThuList.findIndex(pt => pt['ID phiếu thu'] === idPhieuThu);
                    if (currentIndex >= 0) {
                        currentPhieuThuList[currentIndex] = phieuThuData;
                    }
                }

                // Ẩn form sau khi lưu
                document.getElementById('phieuThuFormContainer').classList.add('hidden');

                // Cập nhật lại danh sách và thông tin
                renderPhieuThuList();
                updateTongThuVaConLai();
                renderDonHangList(); // Cập nhật màu trạng thái thanh toán

                hideLoading();

                Swal.fire({
                    icon: 'success',
                    title: action === "Add" ? 'Đã thêm mới' : 'Đã cập nhật',
                    text: `Thông tin phiếu thu đã được ${action === "Add" ? 'thêm' : 'cập nhật'} thành công`,
                    confirmButtonColor: '#0ea5e9',
                    timer: 1500,
                    timerProgressBar: true
                });

            } catch (error) {
                console.error('Lỗi khi lưu thông tin phiếu thu:', error);
                hideLoading();

                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Không thể lưu thông tin phiếu thu. Vui lòng thử lại sau.',
                    confirmButtonColor: '#d33'
                });
            }
        }

        // Sửa lại hàm tìm kiếm để kết hợp với bộ lọc ngày
        function searchDonHang(keyword) {
            showDonHangSkeleton();

            setTimeout(() => {
                // Lấy giá trị của bộ lọc ngày
                const startDateValue = document.getElementById('filterStartDate').value;
                const endDateValue = document.getElementById('filterEndDate').value;

                // Nếu có lọc ngày, áp dụng lọc ngày trước
                if (startDateValue || endDateValue) {
                    // Chuyển đổi chuỗi ngày thành đối tượng Date và xử lý logic tương tự
                    let startDate = null;
                    let endDate = null;

                    if (startDateValue) {
                        startDate = new Date(startDateValue);
                        startDate.setHours(0, 0, 0, 0);
                    }

                    if (endDateValue) {
                        endDate = new Date(endDateValue);
                        endDate.setHours(23, 59, 59, 999);
                    } else if (startDateValue && !endDateValue) {
                        // Nếu chỉ chọn một ngày
                        endDate = new Date(startDateValue);
                        endDate.setHours(23, 59, 59, 999);
                    }

                    if (!startDate) {
                        startDate = new Date(0);
                    }

                    if (!endDate) {
                        endDate = new Date();
                        endDate.setHours(23, 59, 59, 999);
                    }

                    filteredDonHangList = allDonHangList.filter(donHang => {
                        if (!donHang['Ngày đặt hàng']) return false;

                        const orderDate = new Date(donHang['Ngày đặt hàng']);
                        return orderDate >= startDate && orderDate <= endDate;
                    });
                } else {
                    filteredDonHangList = [...allDonHangList];
                }

                // Sau đó lọc theo từ khóa
                if (keyword) {
                    const searchTerm = keyword.toLowerCase();
                    filteredDonHangList = filteredDonHangList.filter(donHang => {
                        const maDH = (donHang['Mã đơn hàng'] || '').toLowerCase();
                        const tenDH = (donHang['Tên đơn hàng'] || '').toLowerCase();
                        const tenKH = (donHang['Tên khách hàng'] || '').toLowerCase();
                        const ngayDH = donHang['Ngày đặt hàng'] ? formatDisplayDate(donHang['Ngày đặt hàng']).toLowerCase() : '';

                        return maDH.includes(searchTerm) ||
                            tenDH.includes(searchTerm) ||
                            tenKH.includes(searchTerm) ||
                            ngayDH.includes(searchTerm);
                    });
                }

                currentPageDonHang = 1; // Reset về trang đầu sau khi tìm kiếm
                renderDonHangList();
            }, 300);
        }


        // Hàm đọc file Excel
        async function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = function (e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // Lấy sheet đầu tiên
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];

                        // Chuyển đổi sang mảng
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };

                reader.onerror = function (error) {
                    reject(error);
                };

                reader.readAsArrayBuffer(file);
            });
        }

        // Hàm xử lý nhập dữ liệu từ Excel
        async function importExcelData() {
            if (!window.importData || !window.importData.rows || window.importData.rows.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Không có dữ liệu',
                    text: 'Không có dữ liệu để nhập',
                    confirmButtonColor: '#d33'
                });
                return;
            }

            if (!selectedDonHang) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Chưa chọn đơn hàng',
                    text: 'Vui lòng chọn đơn hàng trước khi nhập phiếu thu từ Excel',
                    confirmButtonColor: '#0ea5e9'
                });
                return;
            }

            try {
                showLoading('Đang nhập dữ liệu phiếu thu...');

                const headers = window.importData.headers;
                const rows = window.importData.rows;

                // Tìm vị trí các cột
                const soTienIndex = headers.indexOf('Số tiền tạm ứng');
                const ngayTamUngIndex = headers.indexOf('Ngày tạm ứng');
                const ptttIndex = headers.indexOf('Phương thức thanh toán');
                const ghiChuIndex = headers.indexOf('Ghi chú');
                const ghiChuKTIndex = headers.indexOf('Ghi chú kế toán');

                // Kiểm tra cột bắt buộc
                if (soTienIndex === -1 || ngayTamUngIndex === -1 || ptttIndex === -1) {
                    throw new Error('File Excel thiếu các cột bắt buộc: Số tiền tạm ứng, Ngày tạm ứng, Phương thức thanh toán');
                }

                // Chuyển đổi dữ liệu thành phiếu thu
                const phieuThuData = rows.map(row => {
                    // Kiểm tra dữ liệu hợp lệ
                    if (!row[soTienIndex] || !row[ngayTamUngIndex] || !row[ptttIndex]) {
                        return null; // Bỏ qua dòng không hợp lệ
                    }

                    // Định dạng ngày nếu cần
                    let ngayTamUng = row[ngayTamUngIndex];
                    if (typeof ngayTamUng === 'string' && ngayTamUng.includes('/')) {
                        const parts = ngayTamUng.split('/');
                        ngayTamUng = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                    }

                    return {
                        'ID phiếu thu': generateMaPhieuThu(),
                        'ID đơn hàng': selectedDonHang['ID đơn hàng'],
                        'ID nhân viên': urlParams.idNhanVien,
                        'Số tiền tạm ứng': parseFloat(row[soTienIndex]),
                        'Ngày tạm ứng': ngayTamUng,
                        'Phương thức thanh toán': row[ptttIndex],
                        'Ghi chú': ghiChuIndex >= 0 ? row[ghiChuIndex] : '',
                        'Ghi chú kế toán': ghiChuKTIndex >= 0 ? row[ghiChuKTIndex] : '',
                        'Người tạo': urlParams.nguoiTao,
                        'Ngày tạo': formatDate(new Date())
                    };
                }).filter(item => item !== null);

                if (phieuThuData.length === 0) {
                    throw new Error('Không có dữ liệu phiếu thu hợp lệ để nhập');
                }

                // Gọi API để thêm phiếu thu
                await axios({
                    method: 'POST',
                    url: `https://www.appsheet.com/api/v2/apps/${appId}/tables/Phiếu thu/Action`,
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    data: {
                        "Action": "Add",
                        "Properties": {
                            "Locale": "vi-VN",
                            "Timezone": "Asia/Ho_Chi_Minh"
                        },
                        "Rows": phieuThuData
                    }
                });

                // Cập nhật dữ liệu local
                allPhieuThuList = [...allPhieuThuList, ...phieuThuData];
                currentPhieuThuList = [...currentPhieuThuList, ...phieuThuData];

                // Reset và ẩn phần xem trước
                document.getElementById('previewSection').classList.add('hidden');
                window.importData = null;
                document.getElementById('excelFileInput').value = '';

                // Cập nhật lại danh sách và thông tin
                renderPhieuThuList();
                updateTongThuVaConLai();
                renderDonHangList(); // Cập nhật màu trạng thái thanh toán

                hideLoading();

                // Hiển thị thông báo thành công
                Swal.fire({
                    icon: 'success',
                    title: 'Nhập dữ liệu thành công',
                    text: `Đã nhập ${phieuThuData.length} phiếu thu từ file Excel`,
                    confirmButtonColor: '#0ea5e9'
                });

            } catch (error) {
                console.error('Lỗi khi nhập dữ liệu:', error);
                hideLoading();

                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi nhập dữ liệu',
                    text: error.message || 'Không thể nhập dữ liệu phiếu thu. Vui lòng thử lại sau.',
                    confirmButtonColor: '#d33'
                });
            }
        }

        // Tạo template Excel mẫu
        function createExcelTemplate() {
            // Tạo cấu trúc dữ liệu mẫu
            const templateData = [
                // Dòng tiêu đề
                ['Số tiền tạm ứng', 'Ngày tạm ứng', 'Phương thức thanh toán', 'Ghi chú', 'Ghi chú kế toán'],

                // Dòng mẫu 1
                [1000000, '15/03/2025', 'MB', 'Tạm ứng lần 1', 'Đã xác nhận'],

                // Dòng mẫu 2
                [2000000, '20/03/2025', 'VP', 'Thanh toán đợt 2', '']
            ];

            // Tạo worksheet với style tốt hơn
            const ws = XLSX.utils.aoa_to_sheet(templateData);

            // Thiết lập độ rộng cột để dễ nhìn hơn
            const colWidths = [
                { wch: 15 }, // Số tiền tạm ứng
                { wch: 15 }, // Ngày tạm ứng
                { wch: 20 }, // Phương thức thanh toán
                { wch: 30 }, // Ghi chú
                { wch: 30 } // Ghi chú kế toán
            ];

            ws['!cols'] = colWidths;

            // Tạo workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Mẫu phiếu thu");

            // Xuất file Excel và tải xuống
            XLSX.writeFile(wb, "Mau_Phieu_Thu.xlsx");

            // Hiển thị thông báo
            Swal.fire({
                icon: 'success',
                title: 'Tải mẫu nhập',
                text: 'Mẫu nhập phiếu thu đã được tải xuống',
                confirmButtonColor: '#0ea5e9',
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false
            });
        }

        // Kiểm tra kết nối đến API AppSheet
        async function testAppSheetConnection() {
            try {
                showLoading('Đang kiểm tra kết nối...');

                const response = await axios({
                    method: 'POST',
                    url: `https://www.appsheet.com/api/v2/apps/${appId}/tables/Đơn hàng/Action`,
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    data: {
                        "Action": "Find",
                        "Properties": {
                            "Locale": "vi-VN",
                            "Timezone": "Asia/Ho_Chi_Minh",
                            "MaxRecords": 1
                        }
                    }
                });

                hideLoading();

                if (response.status === 200) {
                    console.log('Kết nối API thành công');
                    return true;
                } else {
                    throw new Error('Phản hồi không thành công');
                }

            } catch (error) {
                hideLoading();
                console.error('Lỗi kết nối API:', error);

                let errorMessage = 'Không thể kết nối đến AppSheet API.';
                if (error.response) {
                    errorMessage += ` Status: ${error.response.status}. ${error.response.data?.error || ''}`;
                }

                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi kết nối!',
                    text: errorMessage,
                    confirmButtonColor: '#d33'
                });
                return false;
            }
        }

        // Xử lý scroll to top
        function handleScrollToTop() {
            const scrollToTopBtn = document.getElementById('scrollToTopBtn');

            // Hiển thị/ẩn nút dựa vào vị trí cuộn
            if (window.scrollY > 300) {
                scrollToTopBtn.classList.remove('opacity-0');
                scrollToTopBtn.classList.add('opacity-100');
            } else {
                scrollToTopBtn.classList.remove('opacity-100');
                scrollToTopBtn.classList.add('opacity-0');
            }
        }

        // Thêm mã này vào phần JavaScript
        document.addEventListener('DOMContentLoaded', function () {
            // Toggle hiển thị bộ lọc nâng cao
            document.getElementById('toggleAdvancedFilter').addEventListener('click', function () {
                const advancedOptions = document.getElementById('advancedFilterOptions');
                advancedOptions.classList.toggle('hidden');
            });

            // Thiết lập lọc nhanh cho Hôm nay
            document.getElementById('filterToday').addEventListener('click', function () {
                const today = new Date();
                const formattedDate = formatDate(today);

                document.getElementById('filterStartDate').value = formattedDate;
                document.getElementById('filterEndDate').value = formattedDate;

                // Áp dụng filter
                applyDateFilter();
            });

            // Thiết lập lọc nhanh cho Hôm qua
            document.getElementById('filterYesterday').addEventListener('click', function () {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const formattedDate = formatDate(yesterday);

                document.getElementById('filterStartDate').value = formattedDate;
                document.getElementById('filterEndDate').value = formattedDate;

                // Áp dụng filter
                applyDateFilter();
            });

            // Thiết lập lọc nhanh cho Tuần này
            document.getElementById('filterThisWeek').addEventListener('click', function () {
                const today = new Date();
                const firstDayOfWeek = new Date(today);
                const dayOfWeek = today.getDay(); // 0 = Chủ nhật, 1 = Thứ 2, ...
                const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Biến đổi để Thứ 2 là ngày đầu tuần

                firstDayOfWeek.setDate(today.getDate() - diff);

                document.getElementById('filterStartDate').value = formatDate(firstDayOfWeek);
                document.getElementById('filterEndDate').value = formatDate(today);

                // Áp dụng filter
                applyDateFilter();
            });

            // Thiết lập lọc nhanh cho Tháng này
            document.getElementById('filterThisMonth').addEventListener('click', function () {
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

                document.getElementById('filterStartDate').value = formatDate(firstDayOfMonth);
                document.getElementById('filterEndDate').value = formatDate(today);

                // Áp dụng filter
                applyDateFilter();
            });
        });

        // Format date để input date chấp nhận (yyyy-mm-dd)
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');

            return `${year}-${month}-${day}`;
        }

        // Khởi tạo ban đầu
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                // Khởi tạo Dark Mode
                if (localStorage.getItem('darkMode') === 'true' ||
                    (localStorage.getItem('darkMode') === null &&
                        window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                }

                // Dark mode toggle
                document.getElementById('darkModeToggle').addEventListener('click', function () {
                    document.documentElement.classList.toggle('dark');
                    localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
                });

                // Kiểm tra kết nối API
                const isConnected = await testAppSheetConnection();
                if (!isConnected) {
                    throw new Error('Không thể kết nối đến AppSheet API');
                }

                // Tải tất cả dữ liệu
                await loadAllData();

                // Thêm các sự kiện cho bộ lọc ngày
                document.getElementById('applyDateFilterBtn').addEventListener('click', applyDateFilter);
                document.getElementById('resetDateFilterBtn').addEventListener('click', resetDateFilter);

                // Thiết lập các sự kiện
                document.getElementById('phieuThuForm').addEventListener('submit', savePhieuThu);

                document.getElementById('resetPhieuThuFormBtn').addEventListener('click', function () {
                    resetPhieuThuForm();
                });

                document.getElementById('huyPhieuThuBtn').addEventListener('click', function () {
                    document.getElementById('phieuThuFormContainer').classList.add('hidden');
                });

                document.getElementById('themPhieuThuBtn').addEventListener('click', function () {
                    showAddPhieuThuForm();
                });

                // Thiết lập tìm kiếm với debounce
                const debouncedSearch = debounce(function (e) {
                    searchDonHang(e.target.value.trim());
                }, 300);

                document.getElementById('searchDonHangInput').addEventListener('input', debouncedSearch);

                // Thiết lập phân trang đơn hàng
                document.getElementById('prevPageDonHang').addEventListener('click', function () {
                    if (currentPageDonHang > 1) {
                        currentPageDonHang--;
                        renderDonHangList();
                    }
                });

                document.getElementById('nextPageDonHang').addEventListener('click', function () {
                    if (currentPageDonHang < Math.ceil(filteredDonHangList.length / ITEMS_PER_PAGE)) {
                        currentPageDonHang++;
                        renderDonHangList();
                    }
                });

                // Excel import
                document.getElementById('importExcelBtn').addEventListener('click', function () {
                    if (!selectedDonHang) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Chưa chọn đơn hàng',
                            text: 'Vui lòng chọn đơn hàng trước khi nhập phiếu thu từ Excel',
                            confirmButtonColor: '#0ea5e9'
                        });
                        return;
                    }
                    document.getElementById('excelFileInput').click();
                });

                document.getElementById('excelFileInput').addEventListener('change', async function (e) {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        showLoading('Đang đọc file Excel...');

                        try {
                            // Đọc file Excel
                            const data = await readExcelFile(file);

                            if (!data || data.length <= 1) { // Kiểm tra xem có dữ liệu không (ngoài dòng tiêu đề)
                                throw new Error('File không chứa dữ liệu hợp lệ');
                            }

                            // Lấy dòng tiêu đề
                            const headers = data[0];
                            const requiredColumns = ['Số tiền tạm ứng', 'Ngày tạm ứng', 'Phương thức thanh toán'];

                            // Kiểm tra các cột bắt buộc
                            let missingColumns = [];
                            requiredColumns.forEach(col => {
                                if (!headers.includes(col)) {
                                    missingColumns.push(col);
                                }
                            });

                            if (missingColumns.length > 0) {
                                throw new Error(`File thiếu các cột bắt buộc: ${missingColumns.join(', ')}`);
                            }

                            // Chuẩn bị dữ liệu xem trước (tối đa 5 dòng)
                            const previewData = data.slice(1, 6);

                            // Hiển thị phần xem trước
                            const previewSection = document.getElementById('previewSection');
                            previewSection.classList.remove('hidden');

                            // Tạo tiêu đề bảng xem trước
                            const theadEl = document.querySelector('#previewTable thead');
                            let theadHTML = '<tr>';

                            headers.forEach(header => {
                                theadHTML += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${header}</th>`;
                            });

                            theadHTML += '</tr>';
                            theadEl.innerHTML = theadHTML;

                            // Tạo nội dung bảng xem trước
                            const tbodyEl = document.querySelector('#previewTable tbody');
                            let tbodyHTML = '';

                            previewData.forEach(row => {
                                tbodyHTML += '<tr class="hover:bg-gray-50 dark:hover:bg-gray-700">';

                                headers.forEach((col, index) => {
                                    const value = row[index] || '';
                                    tbodyHTML += `<td class="px-6 py-4 whitespace-nowrap text-sm ${index === 0 ? 'font-medium text-gray-900 dark:text-white' : 'text-gray-700 dark:text-gray-300'}">${value}</td>`;
                                });

                                tbodyHTML += '</tr>';
                            });

                            tbodyEl.innerHTML = tbodyHTML;

                            // Lưu dữ liệu đầy đủ để sử dụng khi xác nhận nhập
                            window.importData = {
                                headers: headers,
                                rows: data.slice(1) // Bỏ qua dòng tiêu đề
                            };

                            hideLoading();

                        } catch (error) {
                            console.error('Error reading Excel file:', error);
                            hideLoading();

                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi đọc file',
                                text: error.message || 'Không thể đọc file Excel. Vui lòng kiểm tra định dạng file.',
                                confirmButtonColor: '#d33'
                            });

                            // Reset file input
                            e.target.value = '';
                        }
                    }
                });

                document.getElementById('cancelImportBtn').addEventListener('click', function () {
                    document.getElementById('previewSection').classList.add('hidden');
                    document.getElementById('excelFileInput').value = '';
                    window.importData = null;
                });

                document.getElementById('confirmImportBtn').addEventListener('click', importExcelData);

                // Thiết lập Scroll to Top
                window.addEventListener('scroll', handleScrollToTop);
                document.getElementById('scrollToTopBtn').addEventListener('click', function () {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });

                document.getElementById('refreshDataBtn').addEventListener('click', async function () {
                    await loadAllData(true);

                    // Nếu đang xem phiếu thu, cập nhật lại
                    if (selectedDonHang) {
                        // Cập nhật lại phiếu thu cho đơn hàng đang chọn
                        currentPhieuThuList = allPhieuThuList.filter(pt => pt['ID đơn hàng'] === selectedDonHang['ID đơn hàng']);
                        renderPhieuThuList();
                        updateTongThuVaConLai();
                    }

                    Swal.fire({
                        icon: 'success',
                        title: 'Dữ liệu đã được làm mới',
                        timer: 1500,
                        timerProgressBar: true,
                        showConfirmButton: false
                    });
                });

                // Set ngày tạm ứng mặc định là hôm nay
                document.getElementById('ngayTamUng').value = formatDate(new Date());

            } catch (error) {
                console.error('Lỗi khởi tạo:', error);

                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi khởi tạo',
                    text: 'Đã xảy ra lỗi khi khởi tạo ứng dụng. Vui lòng thử lại sau.',
                    confirmButtonColor: '#d33'
                });
            }
        });

        // Export các hàm để có thể gọi từ HTML
        window.viewPhieuThu = viewPhieuThu;
        window.editPhieuThu = editPhieuThu;
        window.deletePhieuThu = deletePhieuThu;
        window.createExcelTemplate = createExcelTemplate;
    </script>
</body>

</html>