<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In Nhiều Xác Nhận Đặt Hàng - Đức Thành</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Times+New+Roman:wght@400;700&display=swap');

        @media print {
            @page {
                size: A4 portrait;
                margin: 0.5cm;
            }

            body {
                margin: 0;
                padding: 0;
            }

            .no-print {
                display: none !important;
            }

            .page-break {
                page-break-after: always;
            }

            .print-content {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
            }

            #printContent {
                margin-left: 0 !important;
            }

            #printContent>div {
                margin: 0 auto !important;
                max-width: none !important;
                box-shadow: none !important;
            }
        }

        /* Loading overlay styles */
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #f0a500;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-100 font-['Times_New_Roman']">
    <div id="loadingOverlay" class="hidden">
        <div class="spinner"></div>
        <div class="text-white mt-4">Đang xử lý...</div>
    </div>

    <div class="no-print fixed top-0 left-0 w-80 h-full bg-white shadow-lg flex flex-col">
        <!-- Header -->
        <div class="p-4 bg-amber-500 text-white">
            <h2 class="text-xl font-bold">In Nhiều Xác Nhận Đặt Hàng</h2>
        </div>

        <!-- Search and Filters -->
        <div class="p-4 border-b">
            <div class="relative mb-4">
                <input type="text" id="searchInput" placeholder="Tìm kiếm đơn hàng..."
                    class="w-full p-2 pl-8 border rounded bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-amber-500">
                <svg class="w-4 h-4 absolute left-2 top-3 text-gray-400" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path d="M21 21l-6-6m2-6a7 7 0 11-14 0 7 7 0 0114 0z" stroke-linecap="round" stroke-linejoin="round"
                        stroke-width="2" />
                </svg>
            </div>

            <!-- Date filters -->
            <div class="mb-4">
                <h3 class="text-sm font-medium text-gray-700 mb-2">Lọc theo ngày</h3>
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="text-xs text-gray-500">Từ ngày</label>
                        <input type="date" id="fromDate" class="w-full p-1.5 border rounded text-sm"
                            onchange="filterOrders()">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-gray-500">Đến ngày</label>
                        <input type="date" id="toDate" class="w-full p-1.5 border rounded text-sm"
                            onchange="filterOrders()">
                    </div>
                </div>
            </div>

            <!-- Customer filter -->
            <div class="mb-4">
                <h3 class="text-sm font-medium text-gray-700 mb-2">Khách hàng</h3>
                <select id="customerFilter" class="w-full p-2 border rounded bg-gray-50" onchange="filterOrders()">
                    <option value="">Tất cả khách hàng</option>
                    <!-- Các option sẽ được thêm vào bằng JavaScript -->
                </select>
            </div>

            <!-- Action buttons -->
            <div class="flex gap-2">
                <button onclick="selectAllOrders()"
                    class="flex-1 px-3 py-2 bg-amber-500 text-white rounded hover:bg-amber-600 transition-colors">
                    <span>Chọn tất cả</span>
                </button>
                <button onclick="unselectAllOrders()"
                    class="flex-1 px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                    <span>Bỏ chọn tất cả</span>
                </button>
            </div>
        </div>

        <!-- Order List -->
        <div class="flex-1 overflow-auto p-4 bg-gray-50">
            <div id="orderList" class="space-y-2">
                <!-- Danh sách đơn hàng sẽ được thêm vào đây -->
            </div>
        </div>

        <!-- Footer with selected count -->
        <div class="p-4 border-t bg-white">
            <div id="selectedCount" class="text-center font-medium text-gray-700">
                Đã chọn: 0
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="no-print fixed top-4 right-4 flex gap-2">
        <button onclick="window.print()"
            class="px-4 py-2 bg-amber-500 text-white rounded-lg shadow hover:bg-amber-600 transition-colors flex items-center gap-2">
            <i class="fas fa-print"></i>
            <span>In Đơn Hàng Đã Chọn</span>
        </button>
        <button onclick="exportSelectedToExcel()"
            class="px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition-colors flex items-center gap-2">
            <i class="fas fa-file-excel"></i>
            <span>Xuất Excel</span>
        </button>
        <button onclick="exportSelectedToWord()"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center gap-2">
            <i class="fas fa-file-word"></i>
            <span>Xuất Word</span>
        </button>
    </div>

    <!-- Print Content -->
    <div id="printContent" class="print-content ml-80">
        <!-- Nội dung xác nhận đặt hàng sẽ được thêm vào đây -->
    </div>
    <script src="https://hoangmv.github.io/ducthanh/key.js"></script>
    <script>
        let appData = {
            orders: [],
            customers: {},  // Đổi thành object để truy cập nhanh hơn theo ID
            products: {},   // Lưu trữ sản phẩm theo ID đơn hàng
            selectedOrders: new Set()
        };
        // Constants for AppSheet connection
       
        let allOrders = [];
        let allCustomers = [];
        let selectedOrders = new Set();
        let orderProducts = {};
        let customerCache = {};

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Format currency
        function formatCurrency(number) {
            return number.toLocaleString('vi-VN');
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '/');
        }
        async function fetchAllData() {
            showLoading();
            try {
                // Tải đồng thời tất cả các loại dữ liệu
                const [ordersData, customersData, productsData] = await Promise.all([
                    // Tải tất cả đơn hàng
                    fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/Đơn hàng/Action`, {
                        method: 'POST',
                        headers: {
                            'ApplicationAccessKey': accessKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            Action: 'Find',
                            Properties: {},
                            Selector: 'Filter([Đơn hàng], true)'
                        })
                    }).then(res => res.json()),

                    // Tải tất cả khách hàng
                    fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/Khách hàng/Action`, {
                        method: 'POST',
                        headers: {
                            'ApplicationAccessKey': accessKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            Action: 'Find',
                            Properties: {},
                            Selector: 'Filter([Khách hàng], true)'
                        })
                    }).then(res => res.json()),

                    // Tải tất cả hàng hóa
                    fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/Hàng hoá/Action`, {
                        method: 'POST',
                        headers: {
                            'ApplicationAccessKey': accessKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            Action: 'Find',
                            Properties: {},
                            Selector: 'Filter([Hàng hoá], true)'
                        })
                    }).then(res => res.json())
                ]);

                // Sắp xếp đơn hàng theo ngày, mới nhất trước
                appData.orders = ordersData.sort((a, b) => new Date(b['Ngày đặt hàng']) - new Date(a['Ngày đặt hàng']));

                // Lưu trữ khách hàng dưới dạng object với key là ID
                customersData.forEach(customer => {
                    appData.customers[customer['ID khách hàng']] = customer;
                });

                // Phân nhóm sản phẩm theo ID đơn hàng
                appData.products = productsData.reduce((groups, product) => {
                    const orderId = product['ID đơn hàng'];
                    if (!groups[orderId]) {
                        groups[orderId] = [];
                    }
                    groups[orderId].push(product);
                    return groups;
                }, {});

                return appData;
            } catch (error) {
                console.error('Failed to fetch data:', error);
                alert(`Lỗi khi tải dữ liệu: ${error.message}`);
                throw error;
            } finally {
                hideLoading();
            }
        }
        // Convert number to Vietnamese words
        function numberToWords(num) {
            const units = ['', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'];
            const tens = ['', 'mười', 'hai mươi', 'ba mươi', 'bốn mươi', 'năm mươi', 'sáu mươi', 'bảy mươi', 'tám mươi', 'chín mươi'];
            const scales = ['', 'nghìn', 'triệu', 'tỷ', 'nghìn tỷ', 'triệu tỷ'];

            if (num === 0) return 'không';

            let words = '';
            let scaleIndex = 0;

            while (num > 0) {
                const hundreds = Math.floor(num % 1000 / 100);
                const ten = Math.floor(num % 100 / 10);
                const unit = num % 10;

                let scaleWords = '';

                if (hundreds > 0) {
                    scaleWords += units[hundreds] + ' trăm ';
                }

                if (ten > 1) {
                    scaleWords += tens[ten] + ' ';
                    if (unit > 0) {
                        scaleWords += (unit === 1 && ten > 1) ? 'mốt' : units[unit];
                    }
                } else if (ten === 1) {
                    scaleWords += 'mười ';
                    if (unit > 0) {
                        scaleWords += (unit === 5) ? 'lăm' : units[unit];
                    }
                } else if (unit > 0) {
                    scaleWords += units[unit];
                }

                if (scaleWords) {
                    words = scaleWords + (scaleIndex > 0 ? ' ' + scales[scaleIndex] + ' ' : '') + words;
                }

                num = Math.floor(num / 1000);
                scaleIndex++;
            }

            words = words.trim();
            return words.charAt(0).toUpperCase() + words.slice(1) + ' đồng';
        }

        // Fetch orders from AppSheet
        async function fetchOrders() {
            showLoading();
            try {
                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/Đơn hàng/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {},
                        Selector: 'Filter([Đơn hàng], true)'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (!Array.isArray(data)) {
                    throw new Error('Invalid data format received');
                }

                // Sort by date, newest first
                allOrders = data.sort((a, b) => new Date(b['Ngày đặt hàng']) - new Date(a['Ngày đặt hàng']));
                return allOrders;
            } catch (error) {
                console.error('Failed to fetch orders:', error);
                throw error;
            } finally {
                hideLoading();
            }
        }

        // Fetch customers from AppSheet
        async function fetchCustomers() {
            try {
                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/Khách hàng/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {},
                        Selector: 'Filter([Khách hàng], true)'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (!Array.isArray(data)) {
                    throw new Error('Invalid data format received');
                }

                allCustomers = data;

                // Populate customer filter dropdown
                const customerFilter = document.getElementById('customerFilter');
                customerFilter.innerHTML = '<option value="">Tất cả khách hàng</option>';

                allCustomers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer['ID khách hàng'];
                    option.textContent = customer['Tên khách hàng đầy đủ'];
                    customerFilter.appendChild(option);

                    // Cache customer data by ID for faster lookup
                    customerCache[customer['ID khách hàng']] = customer;
                });

                return allCustomers;
            } catch (error) {
                console.error('Failed to fetch customers:', error);
                throw error;
            }
        }

        // Fetch products for a specific order
        async function fetchProductsByOrderId(orderId) {
            try {
                // Check if already cached
                if (orderProducts[orderId]) {
                    return orderProducts[orderId];
                }

                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/Hàng hoá/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {},
                        Selector: `Filter([Hàng hoá], [ID đơn hàng] = "${orderId}")`
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (!Array.isArray(data)) {
                    throw new Error('Invalid data format received');
                }

                // Filter and cache products for this order
                const products = data.filter(product => product['ID đơn hàng'] === orderId);
                orderProducts[orderId] = products;

                return products;
            } catch (error) {
                console.error(`Failed to fetch products for order ${orderId}:`, error);
                throw error;
            }
        }
        // Cập nhật số lượng đã chọn
        function updateSelectedCount() {
            const count = appData.selectedOrders.size;
            document.getElementById('selectedCount').innerHTML = `
        <div class="flex items-center justify-center gap-2">
            <span class="text-gray-600">Đã chọn:</span>
            <span class="font-bold text-amber-500">${count}</span>
            <span class="text-gray-600">đơn hàng</span>
        </div>
    `;
        }

        // Cập nhật lại hàm chọn/bỏ chọn
        function selectAllOrders() {
            const visibleOrders = getVisibleOrders();
            visibleOrders.forEach(order => {
                appData.selectedOrders.add(order['ID đơn hàng']);
                const checkbox = document.querySelector(`input[data-id="${order['ID đơn hàng']}"]`);
                if (checkbox) checkbox.checked = true;
            });
            updateSelectedCount();
            renderSelectedOrders();
        }

        function unselectAllOrders() {
            appData.selectedOrders.clear();
            document.querySelectorAll('#orderList input[type="checkbox"]')
                .forEach(checkbox => checkbox.checked = false);
            updateSelectedCount();
            renderSelectedOrders();
        }

        function toggleOrder(id, checked) {
            if (checked) {
                appData.selectedOrders.add(id);
            } else {
                appData.selectedOrders.delete(id);
            }
            updateSelectedCount();
            renderSelectedOrders();
        }
        // Cập nhật hàm lấy đơn hàng theo bộ lọc
        function getVisibleOrders() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const customerId = document.getElementById('customerFilter').value;

            return appData.orders.filter(order => {
                // Lọc theo tìm kiếm
                const matchesSearch =
                    (order['Mã đơn hàng']?.toLowerCase() || '').includes(searchTerm) ||
                    (order['ID đơn hàng']?.toLowerCase() || '').includes(searchTerm) ||
                    (appData.customers[order['ID khách hàng']]?.['Tên khách hàng đầy đủ'].toLowerCase() || '').includes(searchTerm);

                // Lọc theo ngày
                let matchesDate = true;
                if (fromDate) {
                    const orderDate = new Date(order['Ngày đặt hàng']);
                    const fromDateObj = new Date(fromDate);
                    matchesDate = matchesDate && orderDate >= fromDateObj;
                }
                if (toDate) {
                    const orderDate = new Date(order['Ngày đặt hàng']);
                    const toDateObj = new Date(toDate);
                    toDateObj.setHours(23, 59, 59); // Cuối ngày
                    matchesDate = matchesDate && orderDate <= toDateObj;
                }

                // Lọc theo khách hàng
                const matchesCustomer = !customerId || order['ID khách hàng'] === customerId;

                return matchesSearch && matchesDate && matchesCustomer;
            });
        }


        // Render the order list based on filters
        function renderOrderList() {
            const filteredOrders = getVisibleOrders();
            const listHTML = filteredOrders.length ? filteredOrders.map(order => {
                const customer = customerCache[order['ID khách hàng']] || { 'Tên khách hàng đầy đủ': 'Không xác định' };

                return `
                    <div class="bg-white rounded-lg shadow-sm hover:shadow transition-shadow">
                        <label class="flex items-center gap-3 p-3 cursor-pointer">
                            <input type="checkbox" 
                                class="w-4 h-4 text-amber-500 rounded focus:ring-amber-500"
                                data-id="${order['ID đơn hàng']}"
                                ${selectedOrders.has(order['ID đơn hàng']) ? 'checked' : ''}
                                onchange="toggleOrder('${order['ID đơn hàng']}', this.checked)">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-medium">${order['Mã đơn hàng']}</span>
                                    <span class="px-2 py-0.5 text-xs rounded-full bg-amber-100 text-amber-800">
                                        ${formatDate(order['Ngày đặt hàng'])}
                                    </span>
                                </div>
                                <div class="text-sm text-gray-500 mt-1">
                                    ${customer['Tên khách hàng đầy đủ']}
                                </div>
                            </div>
                        </label>
                    </div>
                `;
            }).join('') : `
                <div class="text-center text-gray-500 py-8">
                    Không tìm thấy đơn hàng nào
                </div>
            `;

            document.getElementById('orderList').innerHTML = listHTML;
        }

        // Filter orders based on search input and filters
        function filterOrders() {
            renderOrderList();
        }

        // Setup search input event
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', filterOrders);
        }

        // Render a single order template
        // Cập nhật lại hàm renderOrderTemplate để sử dụng dữ liệu đã tải
        function renderOrderTemplate(order) {
            try {
                const orderId = order['ID đơn hàng'];
                const customerId = order['ID khách hàng'];

                // Lấy thông tin khách hàng từ dữ liệu đã lưu
                const customer = appData.customers[customerId] || {
                    'Tên khách hàng đầy đủ': 'Không xác định',
                    'MST': '',
                    'Địa chỉ Hoá đơn': '',
                    'SĐT': '',
                    'Địa chỉ trả hàng': ''
                };

                // Lấy sản phẩm từ dữ liệu đã lưu
                const products = appData.products[orderId] || [];

                // Tạo hàng sản phẩm và tính tổng
                let subtotal = 0;
                const productRows = products.map((product, index) => {
                    const quantity = parseFloat(product['Số lượng']) || 0;
                    const unitPrice = parseFloat(product['Đơn giá']) || 0;
                    const total = parseFloat(product['Thành tiền hàng']) || (quantity * unitPrice);
                    subtotal += total;

                    return `
                <tr>
                    <td  style="border: 1px solid #000; text-align: center;">${index + 1}</td>
                    <td class="product-name" style="border: 1px solid #000; text-align: center;">
                        <div class="product-info" style="text-align: left; padding-left: 10px;">
                            <strong>${product['Tên hàng hoá'] || ''}</strong>
                            <span class="product-description" style="display: block; margin-top: 5px; color: #666;">
                                ${product['Mô tả'] || ''}
                            </span>
                        </div>
                    </td>
                    <td style="border: 1px solid #000; text-align: center; ">${product['Đơn vị tính'] || 'Cái'}</td>
                    <td style="border: 1px solid #000; text-align: center;">${quantity}</td>
                    <td style="border: 1px solid #000; text-align: center;">${formatCurrency(unitPrice)}</td>
                    <td style="border: 1px solid #000; text-align: center;">${formatCurrency(total)}</td>
                </tr>
            `;
                }).join('');

                // Tính thuế và tổng cộng
                const tax = subtotal * 0.08;
                const grandTotal = subtotal + tax;

                // Template HTML giữ nguyên như cũ
                return `
            <div class="max-w-[21cm] mx-auto bg-white p-8 shadow-lg mb-8 page-break" style="font-family: 'Times New Roman', Times, serif; line-height: 1.3; color: #000; font-size: 12pt;">
                <!-- Header -->
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <div style="width: 25%;">
                        <img src="https://hoangmv.github.io/ducthanh/ducthanhlogo.png" alt="DUC THANH" style="max-width: 150px;">
                    </div>
                    <div style="width: 75%; text-align: right; font-size: 11pt; line-height: 1.4;">
                        <div style="font-weight: bold; font-size: 12pt;">CÔNG TY TNHH SẢN XUẤT VÀ DỊCH VỤ ĐỨC THÀNH</div>
                        VPGD: Số 11/49/64 Nguyễn Lương Bằng, Ô Chợ Dừa, Đống Đa, Hà Nội<br>
                        Số ĐKKD: 0108325268. Điện thoại: 024 6682 6686 | Email: <span
                            style="text-decoration: underline;">info@inducthanh.vn</span><br>
                        Website: <span style="text-decoration: underline;">www.inducthanh.com</span> | <span
                            style="text-decoration: underline;">www.inlayngay.vn</span>
                    </div>
                </div>

                <!-- Title -->
                <div style="text-align: center; margin-bottom: 5px;">
                    <h1 style="font-size: 16pt; font-weight: bold; margin: 25px 0 5px 0;">XÁC NHẬN ĐẶT HÀNG</h1>
                    <div><strong>Số đơn hàng:</strong> ${order['Mã đơn hàng']} - <strong>Ngày đặt hàng:</strong> ${formatDate(order['Ngày đặt hàng'])}</div>
                </div>

                <!-- Client Info -->
                <div style="background-color: #f8e0e6; padding: 5px 10px; line-height: 1.1; border-bottom: #000 1px solid !important;">
                    <p style="margin: 5px 0;"><strong>Khách hàng:</strong> ${customer['Tên khách hàng đầy đủ']}</p>
                    <p style="margin: 5px 0;"><strong>Mã số thuế:</strong> ${customer['MST'] || ''}</p>
                    <p style="margin: 5px 0;"><strong>Địa chỉ hoá đơn:</strong> ${customer['Địa chỉ Hoá đơn'] || ''}</p>
                </div>

                <!-- Delivery Info -->
                <div style="background-color: #f8e0e6; padding: 5px 10px; line-height: 1.1;">
                    <div style="display: flex; gap: 20px;">
                        <div style="flex: 1;">
                            <p style="margin: 5px 0;"><strong>Người nhận hàng:</strong> ${customer['Tên khách hàng đầy đủ']}</p>
                        </div>
                        <div style="flex: 1;">
                            <p style="margin: 5px 0;"><strong>SĐT người nhận:</strong> ${customer['SĐT'] || ''}</p>
                        </div>
                    </div>
                    <p style="margin: 5px 0;"><strong>Địa chỉ giao hàng:</strong> ${customer['Địa chỉ trả hàng'] || ''}</p>
                </div>

                <!-- Intro Text -->
                <div style="font-style: italic; margin: 5px 0; line-height: 1.3;">
                    <i>Lời đầu tiên, Đức Thành xin trân trọng cảm ơn quý khách hàng đã lựa chọn sản phẩm của công ty chúng tôi.
                        Chúng tôi xin gửi đến quý khách hàng thông tin chi tiết của đơn hàng như sau:</i>
                </div>

                <!-- Products Table -->
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px; border: 1px solid #000;">
                    <thead>
                        <tr>
                            <th style="width: 10%; background-color: #f8e0e6; color: #000; text-align: center; padding: 8px 4px; font-weight: bold; border: 1px solid #000;">STT</th>
                            <th style="width: 37%; background-color: #f8e0e6; color: #000; text-align: center; padding: 8px 4px; font-weight: bold; border: 1px solid #000;">HÀNG HÓA</th>
                            <th style="width: 10%; background-color: #f8e0e6; color: #000; text-align: center; padding: 8px 4px; font-weight: bold; border: 1px solid #000;">ĐVT</th>
                            <th style="width: 10%; background-color: #f8e0e6; color: #000; text-align: center; padding: 8px 4px; font-weight: bold; border: 1px solid #000;">SL</th>
                            <th style="width: 17%; background-color: #f8e0e6; color: #000; text-align: center; padding: 8px 4px; font-weight: bold; border: 1px solid #000;">ĐƠN GIÁ</th>
                            <th style="width: 17%; background-color: #f8e0e6; color: #000; text-align: center; padding: 8px 4px; font-weight: bold; border: 1px solid #000;">THÀNH TIỀN</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${productRows}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="5" style="text-align: center; font-weight: bold; border: 1px solid #000; padding: 6px 4px;">Cộng tiền hàng</td>
                            <td style="border: 1px solid #000; padding: 6px 4px; text-align: right;">${formatCurrency(subtotal)}</td>
                        </tr>
                        <tr>
                            <td colspan="5" style="text-align: center; font-weight: bold; border: 1px solid #000; padding: 6px 4px;">Thuế GTGT (8%)</td>
                            <td style="border: 1px solid #000; padding: 6px 4px; text-align: right;">${formatCurrency(tax)}</td>
                        </tr>
                        <tr>
                            <td colspan="5" style="text-align: center; font-weight: bold; border: 1px solid #000; padding: 6px 4px;">Cộng</td>
                            <td style="border: 1px solid #000; padding: 6px 4px; text-align: right; font-weight: bold;">${formatCurrency(grandTotal)}</td>
                        </tr>
                    </tfoot>
                </table>

                <!-- Total in Words -->
                <div style="font-weight: bold; margin-bottom: 10px;">
                    Số tiền viết bằng chữ: ${numberToWords(Math.round(grandTotal))}.
                </div>

                <!-- Signatures -->
                <div style="display: flex; justify-content: space-between; margin-top: 30px; text-align: center;">
                    <div style="width: 45%;">
                        <p style="margin: 5px 0;"><strong>BÊN MUA</strong></p>
                        <p style="margin: 5px 0;"><i>(Ký, họ tên)</i></p>
                    </div>
                    <div style="width: 45%;">
                        <p style="margin: 5px 0;"><strong>BÊN BÁN</strong></p>
                        <p style="margin: 5px 0;"><i>(Ký, họ tên)</i></p>
                    </div>
                </div>
            </div>
        `;
            } catch (error) {
                console.error(`Error rendering order template for order ${order['ID đơn hàng']}:`, error);
                return `
            <div class="max-w-[21cm] mx-auto bg-white p-8 shadow-lg mb-8 page-break">
                <div class="text-center text-red-500">
                    <h2 class="text-xl font-bold mb-4">Lỗi hiển thị đơn hàng</h2>
                    <p>Không thể hiển thị đơn hàng ${order['Mã đơn hàng'] || order['ID đơn hàng']}.</p>
                    <p>Chi tiết lỗi: ${error.message}</p>
                </div>
            </div>
        `;
            }
        }

        // Hàm tải script động
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        // Cập nhật lại hàm renderSelectedOrders để sử dụng dữ liệu đã lưu
        async function renderSelectedOrders() {
            if (appData.selectedOrders.size === 0) {
                document.getElementById('printContent').innerHTML =
                    '<div class="p-8 text-center text-gray-500">Chưa có đơn hàng nào được chọn</div>';
                return;
            }

            showLoading();

            try {
                // Lọc ra các đơn hàng đã chọn
                const selectedOrdersList = appData.orders.filter(order =>
                    appData.selectedOrders.has(order['ID đơn hàng'])
                );

                // Tạo thông báo tiến trình
                document.getElementById('printContent').innerHTML =
                    `<div class="p-8 text-center text-gray-500">Đang chuẩn bị ${appData.selectedOrders.size} đơn hàng để in...</div>`;

                // Render tất cả đơn hàng đã chọn
                const html = selectedOrdersList.map(order => renderOrderTemplate(order));

                // Cập nhật nội dung hiển thị
                document.getElementById('printContent').innerHTML = html.join('');
            } catch (error) {
                console.error('Error rendering selected orders:', error);
                document.getElementById('printContent').innerHTML =
                    `<div class="p-8 text-center text-red-500">Lỗi khi chuẩn bị đơn hàng: ${error.message}</div>`;
            } finally {
                hideLoading();
            }
        }

        // Export all selected orders to Excel
        // Cập nhật hàm xuất Excel
       // Hàm tải script động nếu chưa có
function loadScript(src) {
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

// Cập nhật hàm xuất Excel
async function exportSelectedToExcel() {
    if (appData.selectedOrders.size === 0) {
        alert('Vui lòng chọn ít nhất một đơn hàng để xuất Excel');
        return;
    }

    showLoading();

    try {
        // Tải thư viện ExcelJS nếu chưa có
        if (typeof ExcelJS === 'undefined') {
            await loadScript('https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js');
        }
        if (typeof saveAs === 'undefined') {
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js');
        }

        // Lọc ra các đơn hàng đã chọn
        const selectedOrdersList = appData.orders.filter(order =>
            appData.selectedOrders.has(order['ID đơn hàng'])
        );

        // Nếu chỉ có một đơn hàng, xuất chi tiết
        if (selectedOrdersList.length === 1) {
            await exportSingleOrderToExcel(selectedOrdersList[0]);
        } 
        // Nếu có nhiều đơn hàng, xuất dưới dạng nhiều sheet
        else {
            await exportMultipleOrdersToExcel(selectedOrdersList);
        }
    } catch (error) {
        console.error('Error exporting to Excel:', error);
        alert(`Lỗi khi xuất Excel: ${error.message}`);
    } finally {
        hideLoading();
    }
}

// Hàm xuất một đơn hàng chi tiết với định dạng đẹp
async function exportSingleOrderToExcel(order) {
    try {
        const orderId = order['ID đơn hàng'];
        const customer = appData.customers[order['ID khách hàng']] || { 'Tên khách hàng đầy đủ': 'Không xác định' };
        const products = appData.products[orderId] || [];

        // Tạo workbook và worksheet mới
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Xác nhận đặt hàng');

        // Tải logo từ URL
        const logoResponse = await fetch('https://hoangmv.github.io/ducthanh/ducthanhlogo.png');
        const logoArrayBuffer = await logoResponse.arrayBuffer();

        // Thêm logo vào worksheet
        const logoId = workbook.addImage({
            buffer: logoArrayBuffer,
            extension: 'png',
        });

        // Chèn logo vào ô A1 với kích thước phù hợp
        worksheet.addImage(logoId, {
            tl: { col: 0, row: 0 },      // Top-left corner (ô A1)
            br: { col: 1.5, row: 3 },    // Bottom-right corner
            editAs: 'oneCell'            // Giữ tỷ lệ khi điều chỉnh kích thước ô
        });

        // Thêm header công ty (đặt bên cạnh logo)
        worksheet.mergeCells('C1:I1');
        const headerCell = worksheet.getCell('C1');
        headerCell.value = 'CÔNG TY TNHH SẢN XUẤT VÀ DỊCH VỤ ĐỨC THÀNH';
        headerCell.font = { bold: true, size: 14 };
        headerCell.alignment = { horizontal: 'right' };

        worksheet.mergeCells('C2:I2');
        worksheet.getCell('C2').value = 'VPGD: Số 11/49/64 Nguyễn Lương Bằng, Ô Chợ Dừa, Đống Đa, Hà Nội';
        worksheet.getCell('C2').alignment = { horizontal: 'right' };

        worksheet.mergeCells('C3:I3');
        worksheet.getCell('C3').value = 'Số ĐKKD: 0108325268. Điện thoại: 024 6682 6686 | Email: info@inducthanh.vn';
        worksheet.getCell('C3').alignment = { horizontal: 'right' };

        // Tiêu đề xác nhận đặt hàng
        worksheet.mergeCells('A5:I5');
        const titleCell = worksheet.getCell('A5');
        titleCell.value = 'XÁC NHẬN ĐẶT HÀNG';
        titleCell.font = { bold: true, size: 16 };
        titleCell.alignment = { horizontal: 'center' };

        // Thông tin đơn hàng
        worksheet.mergeCells('A6:I6');
        worksheet.getCell('A6').value = `Số đơn hàng: ${order['Mã đơn hàng']} - Ngày đặt hàng: ${formatDate(order['Ngày đặt hàng'])}`;
        worksheet.getCell('A6').alignment = { horizontal: 'center' };

        // Thông tin khách hàng
        worksheet.mergeCells('A8:I8');
        worksheet.getCell('A8').value = `Khách hàng: ${customer['Tên khách hàng đầy đủ']}`;
        worksheet.getCell('A8').fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'F8E0E6' }
        };

        worksheet.mergeCells('A9:I9');
        worksheet.getCell('A9').value = `Mã số thuế: ${customer['MST'] || ''}`;
        worksheet.getCell('A9').fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'F8E0E6' }
        };

        worksheet.mergeCells('A10:I10');
        worksheet.getCell('A10').value = `Địa chỉ hoá đơn: ${customer['Địa chỉ Hoá đơn'] || ''}`;
        worksheet.getCell('A10').fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'F8E0E6' }
        };

        // Thông tin giao hàng
        worksheet.mergeCells('A12:D12');
        worksheet.getCell('A12').value = `Người nhận hàng: ${customer['Tên khách hàng đầy đủ']}`;
        worksheet.getCell('A12').fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'F8E0E6' }
        };

        worksheet.mergeCells('E12:I12');
        worksheet.getCell('E12').value = `SĐT người nhận: ${customer['SĐT'] || ''}`;
        worksheet.getCell('E12').fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'F8E0E6' }
        };

        worksheet.mergeCells('A13:I13');
        worksheet.getCell('A13').value = `Địa chỉ giao hàng: ${customer['Địa chỉ trả hàng'] || ''}`;
        worksheet.getCell('A13').fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'F8E0E6' }
        };

        // Thêm lời mở đầu
        worksheet.mergeCells('A15:I15');
        worksheet.getCell('A15').value = 'Lời đầu tiên, Đức Thành xin trân trọng cảm ơn quý khách hàng đã lựa chọn sản phẩm của công ty chúng tôi.';
        worksheet.getCell('A15').font = { italic: true };
        
        worksheet.mergeCells('A16:I16');
        worksheet.getCell('A16').value = 'Chúng tôi xin gửi đến quý khách hàng thông tin chi tiết của đơn hàng như sau:';
        worksheet.getCell('A16').font = { italic: true };

        // Thêm header bảng
        const headerRow = worksheet.addRow(['STT', 'HÀNG HÓA', '', '', '', 'ĐVT', 'SL', 'ĐƠN GIÁ', 'THÀNH TIỀN']);
        worksheet.mergeCells('B18:E18');

        // Style cho header
        headerRow.eachCell((cell) => {
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'F8E0E6' }
            };
            cell.font = { bold: true };
            cell.alignment = { horizontal: 'center', vertical: 'middle' };
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
        });

        // Lấy dữ liệu sản phẩm
        let currentRow = 19;
        let subtotal = 0;

        products.forEach((product, index) => {
            // Trích xuất thông tin sản phẩm
            const tenHangHoa = product['Tên hàng hoá'] || '';
            const moTa = product['Mô tả'] || '';

            // Phân tích các giá trị số
            const quantity = parseFloat(product['Số lượng']) || 0;
            const unitPrice = parseFloat(product['Đơn giá']) || 0;
            const total = parseFloat(product['Thành tiền hàng']) || (quantity * unitPrice);
            subtotal += total;

            // Thêm dòng sản phẩm
            const productRow = worksheet.addRow([index + 1, tenHangHoa, '', '', '', product['Đơn vị tính'] || 'Cái', quantity, unitPrice, total]);
            worksheet.mergeCells(`B${currentRow}:E${currentRow}`);

            // Style cho các ô
            productRow.eachCell((cell) => {
                cell.border = {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                };
            });

            // Căn lề cho các loại dữ liệu
            productRow.getCell(1).alignment = { horizontal: 'center' }; // STT
            productRow.getCell(2).alignment = { horizontal: 'left' };   // Tên hàng
            productRow.getCell(6).alignment = { horizontal: 'center' }; // ĐVT
            productRow.getCell(7).alignment = { horizontal: 'center' }; // SL
            productRow.getCell(8).alignment = { horizontal: 'right' };  // Đơn giá
            productRow.getCell(9).alignment = { horizontal: 'right' };  // Thành tiền

            // Format tiền tệ
            productRow.getCell(8).numFmt = '#,##0';
            productRow.getCell(9).numFmt = '#,##0';

            currentRow++;

            // Nếu có mô tả, thêm dòng mô tả
            if (moTa) {
                const descRow = worksheet.addRow(['', moTa, '', '', '', '', '', '', '']);
                worksheet.mergeCells(`B${currentRow}:E${currentRow}`);

                // Style cho dòng mô tả
                descRow.eachCell((cell) => {
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                });

                descRow.getCell(2).alignment = { horizontal: 'left' };
                descRow.getCell(2).font = { color: { argb: '666666' } };

                currentRow++;
            }
        });

        // Tính thuế và tổng tiền
        const tax = subtotal * 0.08;
        const grandTotal = subtotal + tax;

        // Thêm dòng tổng cộng tiền hàng
        const subtotalRow = worksheet.addRow(['', '', '', '', '', 'Cộng tiền hàng', '', '', subtotal]);
        worksheet.mergeCells(`A${currentRow}:F${currentRow}`);

        // Style cho dòng tổng
        subtotalRow.eachCell((cell) => {
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
        });
        subtotalRow.getCell(6).alignment = { horizontal: 'center', vertical: 'middle' };
        subtotalRow.getCell(6).font = { bold: true };
        subtotalRow.getCell(9).alignment = { horizontal: 'right' };
        subtotalRow.getCell(9).numFmt = '#,##0';

        currentRow++;

        // Thêm dòng thuế
        const taxRow = worksheet.addRow(['', '', '', '', '', 'Thuế GTGT (8%)', '', '', tax]);
        worksheet.mergeCells(`A${currentRow}:F${currentRow}`);

        taxRow.eachCell((cell) => {
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
        });
        taxRow.getCell(6).alignment = { horizontal: 'center', vertical: 'middle' };
        taxRow.getCell(6).font = { bold: true };
        taxRow.getCell(9).alignment = { horizontal: 'right' };
        taxRow.getCell(9).numFmt = '#,##0';

        currentRow++;

        // Thêm dòng cộng tổng
        const totalRow = worksheet.addRow(['', '', '', '', '', 'Cộng', '', '', grandTotal]);
        worksheet.mergeCells(`A${currentRow}:F${currentRow}`);

        totalRow.eachCell((cell) => {
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
        });
        totalRow.getCell(6).alignment = { horizontal: 'center', vertical: 'middle' };
        totalRow.getCell(6).font = { bold: true };
        totalRow.getCell(9).alignment = { horizontal: 'right' };
        totalRow.getCell(9).font = { bold: true };
        totalRow.getCell(9).numFmt = '#,##0';

        currentRow += 2;

        // Thêm dòng tiền bằng chữ
        worksheet.mergeCells(`A${currentRow}:I${currentRow}`);
        worksheet.getCell(`A${currentRow}`).value = `Số tiền viết bằng chữ: ${numberToWords(Math.round(grandTotal))}`;
        worksheet.getCell(`A${currentRow}`).font = { bold: true };

        currentRow += 3;

        // Thêm phần chữ ký
        const buyerCell = worksheet.getCell(`C${currentRow}`);
        buyerCell.value = 'BÊN MUA';
        buyerCell.font = { bold: true };
        buyerCell.alignment = { horizontal: 'center' };

        const sellerCell = worksheet.getCell(`G${currentRow}`);
        sellerCell.value = 'BÊN BÁN';
        sellerCell.font = { bold: true };
        sellerCell.alignment = { horizontal: 'center' };

        currentRow++;

        worksheet.getCell(`C${currentRow}`).value = '(Ký, họ tên)';
        worksheet.getCell(`C${currentRow}`).alignment = { horizontal: 'center' };
        worksheet.getCell(`C${currentRow}`).font = { italic: true };

        worksheet.getCell(`G${currentRow}`).value = '(Ký, họ tên)';
        worksheet.getCell(`G${currentRow}`).alignment = { horizontal: 'center' };
        worksheet.getCell(`G${currentRow}`).font = { italic: true };

        // Thiết lập độ rộng cột
        worksheet.columns = [
            { width: 8 },   // A - STT
            { width: 30 },  // B - Hàng hóa
            { width: 10 },  // C
            { width: 10 },  // D
            { width: 10 },  // E
            { width: 10 },  // F - ĐVT
            { width: 10 },  // G - SL
            { width: 15 },  // H - Đơn giá
            { width: 15 },  // I - Thành tiền
        ];

        // Tạo blob và tải xuống
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        saveAs(blob, `Xac_nhan_dat_hang_${order['Mã đơn hàng']}.xlsx`);

    } catch (error) {
        console.error('Error exporting order to Excel:', error);
        throw error;
    }
}

// Hàm xuất nhiều đơn hàng vào các sheet khác nhau
async function exportMultipleOrdersToExcel(orders) {
    try {
        // Tạo workbook mới
        const workbook = new ExcelJS.Workbook();
        
        // Tải logo cho mỗi sheet
        const logoResponse = await fetch('https://hoangmv.github.io/ducthanh/ducthanhlogo.png');
        const logoArrayBuffer = await logoResponse.arrayBuffer();
        
        // Thêm logo vào workbook
        const logoId = workbook.addImage({
            buffer: logoArrayBuffer,
            extension: 'png',
        });

        // Xử lý từng đơn hàng
        for (const order of orders) {
            try {
                const orderId = order['ID đơn hàng'];
                const customer = appData.customers[order['ID khách hàng']] || { 'Tên khách hàng đầy đủ': 'Không xác định' };
                const products = appData.products[orderId] || [];
                
                // Tạo tên sheet an toàn (giới hạn 31 ký tự và loại bỏ ký tự đặc biệt)
                const safeSheetName = order['Mã đơn hàng'].replace(/[\\\/\[\]\*\?:]/g, '_').substring(0, 31);
                const worksheet = workbook.addWorksheet(safeSheetName);
                
                // Chèn logo
                worksheet.addImage(logoId, {
                    tl: { col: 0, row: 0 },
                    br: { col: 1.5, row: 3 },
                    editAs: 'oneCell'
                });

                // Thêm header công ty
                worksheet.mergeCells('C1:I1');
                const headerCell = worksheet.getCell('C1');
                headerCell.value = 'CÔNG TY TNHH SẢN XUẤT VÀ DỊCH VỤ ĐỨC THÀNH';
                headerCell.font = { bold: true, size: 14 };
                headerCell.alignment = { horizontal: 'right' };

                worksheet.mergeCells('C2:I2');
                worksheet.getCell('C2').value = 'VPGD: Số 11/49/64 Nguyễn Lương Bằng, Ô Chợ Dừa, Đống Đa, Hà Nội';
                worksheet.getCell('C2').alignment = { horizontal: 'right' };

                worksheet.mergeCells('C3:I3');
                worksheet.getCell('C3').value = 'Số ĐKKD: 0108325268. Điện thoại: 024 6682 6686 | Email: info@inducthanh.vn';
                worksheet.getCell('C3').alignment = { horizontal: 'right' };

                // Tiêu đề xác nhận đặt hàng
                worksheet.mergeCells('A5:I5');
                const titleCell = worksheet.getCell('A5');
                titleCell.value = 'XÁC NHẬN ĐẶT HÀNG';
                titleCell.font = { bold: true, size: 16 };
                titleCell.alignment = { horizontal: 'center' };

                // Thông tin đơn hàng
                worksheet.mergeCells('A6:I6');
                worksheet.getCell('A6').value = `Số đơn hàng: ${order['Mã đơn hàng']} - Ngày đặt hàng: ${formatDate(order['Ngày đặt hàng'])}`;
                worksheet.getCell('A6').alignment = { horizontal: 'center' };

                // Thông tin khách hàng
                worksheet.mergeCells('A8:I8');
                worksheet.getCell('A8').value = `Khách hàng: ${customer['Tên khách hàng đầy đủ']}`;
                worksheet.getCell('A8').fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'F8E0E6' }
                };

                worksheet.mergeCells('A9:I9');
                worksheet.getCell('A9').value = `Mã số thuế: ${customer['MST'] || ''}`;
                worksheet.getCell('A9').fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'F8E0E6' }
                };

                worksheet.mergeCells('A10:I10');
                worksheet.getCell('A10').value = `Địa chỉ hoá đơn: ${customer['Địa chỉ Hoá đơn'] || ''}`;
                worksheet.getCell('A10').fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'F8E0E6' }
                };

                // Thông tin giao hàng
                worksheet.mergeCells('A12:D12');
                worksheet.getCell('A12').value = `Người nhận hàng: ${customer['Tên khách hàng đầy đủ']}`;
                worksheet.getCell('A12').fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'F8E0E6' }
                };

                worksheet.mergeCells('E12:I12');
                worksheet.getCell('E12').value = `SĐT người nhận: ${customer['SĐT'] || ''}`;
                worksheet.getCell('E12').fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'F8E0E6' }
                };

                worksheet.mergeCells('A13:I13');
                worksheet.getCell('A13').value = `Địa chỉ giao hàng: ${customer['Địa chỉ trả hàng'] || ''}`;
                worksheet.getCell('A13').fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'F8E0E6' }
                };

                // Thêm lời mở đầu
                worksheet.mergeCells('A15:I15');
                worksheet.getCell('A15').value = 'Lời đầu tiên, Đức Thành xin trân trọng cảm ơn quý khách hàng đã lựa chọn sản phẩm của công ty chúng tôi.';
                worksheet.getCell('A15').font = { italic: true };
                
                worksheet.mergeCells('A16:I16');
                worksheet.getCell('A16').value = 'Chúng tôi xin gửi đến quý khách hàng thông tin chi tiết của đơn hàng như sau:';
                worksheet.getCell('A16').font = { italic: true };

                // Thêm header bảng
                const headerRow = worksheet.addRow(['STT', 'HÀNG HÓA', '', '', '', 'ĐVT', 'SL', 'ĐƠN GIÁ', 'THÀNH TIỀN']);
                worksheet.mergeCells('B18:E18');

                // Style cho header
                headerRow.eachCell((cell) => {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'F8E0E6' }
                    };
                    cell.font = { bold: true };
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                });

                // Lấy dữ liệu sản phẩm
                let currentRow = 19;
                let subtotal = 0;

                products.forEach((product, index) => {
                    // Trích xuất thông tin sản phẩm
                    const tenHangHoa = product['Tên hàng hoá'] || '';
                    const moTa = product['Mô tả'] || '';

                    // Phân tích các giá trị số
                    const quantity = parseFloat(product['Số lượng']) || 0;
                    const unitPrice = parseFloat(product['Đơn giá']) || 0;
                    const total = parseFloat(product['Thành tiền hàng']) || (quantity * unitPrice);
                    subtotal += total;

                    // Thêm dòng sản phẩm
                    const productRow = worksheet.addRow([index + 1, tenHangHoa, '', '', '', product['Đơn vị tính'] || 'Cái', quantity, unitPrice, total]);
                    worksheet.mergeCells(`B${currentRow}:E${currentRow}`);

                    // Style cho các ô
                    productRow.eachCell((cell) => {
                        cell.border = {
                            top: { style: 'thin' },
                            left: { style: 'thin' },
                            bottom: { style: 'thin' },
                            right: { style: 'thin' }
                        };
                    });

                    // Căn lề cho các loại dữ liệu
                    productRow.getCell(1).alignment = { horizontal: 'center' }; // STT
                    productRow.getCell(2).alignment = { horizontal: 'left' };   // Tên hàng
                    productRow.getCell(6).alignment = { horizontal: 'center' }; // ĐVT
                    productRow.getCell(7).alignment = { horizontal: 'center' }; // SL
                    productRow.getCell(8).alignment = { horizontal: 'right' };  // Đơn giá
                    productRow.getCell(9).alignment = { horizontal: 'right' };  // Thành tiền

                    // Format tiền tệ
                    productRow.getCell(8).numFmt = '#,##0';
                    productRow.getCell(9).numFmt = '#,##0';

                    currentRow++;

                    // Nếu có mô tả, thêm dòng mô tả
                    if (moTa) {
                        const descRow = worksheet.addRow(['', moTa, '', '', '', '', '', '', '']);
                        worksheet.mergeCells(`B${currentRow}:E${currentRow}`);

                        // Style cho dòng mô tả
                        descRow.eachCell((cell) => {
                            cell.border = {
                                top: { style: 'thin' },
                                left: { style: 'thin' },
                                bottom: { style: 'thin' },
                                right: { style: 'thin' }
                            };
                        });

                        descRow.getCell(2).alignment = { horizontal: 'left' };
                        descRow.getCell(2).font = { color: { argb: '666666' } };

                        currentRow++;
                    }
                });

                // Tính thuế và tổng tiền
                const tax = subtotal * 0.08;
                const grandTotal = subtotal + tax;

                // Thêm dòng tổng cộng tiền hàng
                const subtotalRow = worksheet.addRow(['', '', '', '', '', 'Cộng tiền hàng', '', '', subtotal]);
                worksheet.mergeCells(`A${currentRow}:F${currentRow}`);

                // Style cho dòng tổng
                subtotalRow.eachCell((cell) => {
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                });
                subtotalRow.getCell(6).alignment = { horizontal: 'center', vertical: 'middle'   };
                // Style cho dòng tổng
                subtotalRow.eachCell((cell) => {
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                });
                subtotalRow.getCell(6).alignment = { horizontal: 'center', vertical: 'middle' };
                subtotalRow.getCell(6).font = { bold: true };
                subtotalRow.getCell(9).alignment = { horizontal: 'right' };
                subtotalRow.getCell(9).numFmt = '#,##0';

                currentRow++;

                // Thêm dòng thuế
                const taxRow = worksheet.addRow(['', '', '', '', '', 'Thuế GTGT (8%)', '', '', tax]);
                worksheet.mergeCells(`A${currentRow}:F${currentRow}`);

                taxRow.eachCell((cell) => {
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                });
                taxRow.getCell(6).alignment = { horizontal: 'center', vertical: 'middle' };
                taxRow.getCell(6).font = { bold: true };
                taxRow.getCell(9).alignment = { horizontal: 'right' };
                taxRow.getCell(9).numFmt = '#,##0';

                currentRow++;

                // Thêm dòng cộng tổng
                const totalRow = worksheet.addRow(['', '', '', '', '', 'Cộng', '', '', grandTotal]);
                worksheet.mergeCells(`A${currentRow}:F${currentRow}`);

                totalRow.eachCell((cell) => {
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                });
                totalRow.getCell(6).alignment = { horizontal: 'center', vertical: 'middle' };
                totalRow.getCell(6).font = { bold: true };
                totalRow.getCell(9).alignment = { horizontal: 'right' };
                totalRow.getCell(9).font = { bold: true };
                totalRow.getCell(9).numFmt = '#,##0';

                currentRow += 2;

                // Thêm dòng tiền bằng chữ
                worksheet.mergeCells(`A${currentRow}:I${currentRow}`);
                worksheet.getCell(`A${currentRow}`).value = `Số tiền viết bằng chữ: ${numberToWords(Math.round(grandTotal))}`;
                worksheet.getCell(`A${currentRow}`).font = { bold: true };

                currentRow += 3;

                // Thêm phần chữ ký
                const buyerCell = worksheet.getCell(`C${currentRow}`);
                buyerCell.value = 'BÊN MUA';
                buyerCell.font = { bold: true };
                buyerCell.alignment = { horizontal: 'center' };

                const sellerCell = worksheet.getCell(`G${currentRow}`);
                sellerCell.value = 'BÊN BÁN';
                sellerCell.font = { bold: true };
                sellerCell.alignment = { horizontal: 'center' };

                currentRow++;

                worksheet.getCell(`C${currentRow}`).value = '(Ký, họ tên)';
                worksheet.getCell(`C${currentRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`C${currentRow}`).font = { italic: true };

                worksheet.getCell(`G${currentRow}`).value = '(Ký, họ tên)';
                worksheet.getCell(`G${currentRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`G${currentRow}`).font = { italic: true };
                
                // Thiết lập độ rộng cột
                worksheet.columns = [
                    { width: 8 },   // A - STT
                    { width: 30 },  // B - Hàng hóa
                    { width: 10 },  // C
                    { width: 10 },  // D
                    { width: 10 },  // E
                    { width: 10 },  // F - ĐVT
                    { width: 10 },  // G - SL
                    { width: 15 },  // H - Đơn giá
                    { width: 15 },  // I - Thành tiền
                ];
                
            } catch (error) {
                console.error(`Error processing order ${order['ID đơn hàng']} for Excel:`, error);
                // Tiếp tục với đơn hàng tiếp theo
            }
        }

        // Tạo và tải file Excel
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        saveAs(blob, `Xac_nhan_dat_hang_${appData.selectedOrders.size}_don.xlsx`);
        
    } catch (error) {
        console.error('Error exporting multiple orders to Excel:', error);
        throw error;
    }
}
       
        // Export all selected orders to Word
        async function exportSelectedToWord() {
            if (appData.selectedOrders.size === 0) {
                alert('Vui lòng chọn ít nhất một đơn hàng để xuất Word');
                return;
            }

            showLoading();

            try {
                // Tải các thư viện cần thiết nếu chưa có
                if (typeof PizZip === 'undefined' || typeof docxtemplater === 'undefined' || typeof saveAs === 'undefined') {
                    await Promise.all([
                        loadScript('https://unpkg.com/pizzip@3.1.4/dist/pizzip.js'),
                        loadScript('https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js'),
                        loadScript('https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js')
                    ]);
                }

                // Lọc ra các đơn hàng đã chọn
                const selectedOrdersList = appData.orders.filter(order =>
                    appData.selectedOrders.has(order['ID đơn hàng'])
                );

                // Tải template từ server
                const response = await fetch('https://hoangmv.github.io/templates/order_template.docx');
                if (!response.ok) {
                    throw new Error('Không thể tải template Word');
                }
                const templateContent = await response.arrayBuffer();

                // Tạo một file ZIP chứa tất cả các đơn hàng đã được xuất
                const zipFiles = [];

                // Xử lý từng đơn hàng
                for (const order of selectedOrdersList) {
                    try {
                        const orderId = order['ID đơn hàng'];
                        const customerId = order['ID khách hàng'];

                        // Lấy thông tin khách hàng
                        const customer = appData.customers[customerId] || {
                            'Tên khách hàng đầy đủ': 'Không xác định',
                            'MST': '',
                            'Địa chỉ Hoá đơn': '',
                            'SĐT': '',
                            'Địa chỉ trả hàng': ''
                        };

                        // Lấy danh sách sản phẩm
                        const products = appData.products[orderId] || [];

                        // Tính toán tổng tiền
                        let subtotal = 0;
                        const formattedProducts = products.map((product, index) => {
                            const quantity = parseFloat(product['Số lượng']) || 0;
                            const unitPrice = parseFloat(product['Đơn giá']) || 0;
                            const total = parseFloat(product['Thành tiền hàng']) || (quantity * unitPrice);
                            subtotal += total;

                            return {
                                stt: (index + 1).toString(),
                                ten_hang_hoa: product['Tên hàng hoá'] || '',
                                mo_ta: product['Mô tả'] || '',
                                dvt: product['Đơn vị tính'] || 'Cái',
                                so_luong: formatCurrency(quantity),
                                don_gia: formatCurrency(unitPrice),
                                thanh_tien: formatCurrency(total)
                            };
                        });

                        // Tính thuế và tổng tiền
                        const tax = subtotal * 0.08;
                        const grandTotal = subtotal + tax;

                        // Tạo instance mới của PizZip và docxtemplater
                        const zip = new PizZip(templateContent);
                        const doc = new docxtemplater(zip, {
                            paragraphLoop: true,
                            linebreaks: true
                        });

                        // Đặt dữ liệu vào template
                        const data = {
                            order_number: order['Mã đơn hàng'] || '',
                            order_date: formatDate(order['Ngày đặt hàng'] || new Date()),
                            customer_name: customer['Tên khách hàng đầy đủ'] || '',
                            tax_code: customer['MST'] || '',
                            invoice_address: customer['Địa chỉ Hoá đơn'] || '',
                            recipient_name: customer['Tên khách hàng đầy đủ'] || '',
                            recipient_phone: customer['SĐT'] || '',
                            delivery_address: customer['Địa chỉ trả hàng'] || '',
                            products: formattedProducts,
                            subtotal: formatCurrency(subtotal),
                            tax_amount: formatCurrency(tax),
                            grand_total: formatCurrency(grandTotal),
                            total_in_words: `Số tiền viết bằng chữ: ${numberToWords(Math.round(grandTotal))}.`
                        };

                        // Render template với dữ liệu
                        doc.setData(data);
                        doc.render();

                        // Tạo và thêm file vào danh sách
                        const blob = doc.getZip().generate({
                            type: "blob",
                            mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                        });

                        const fileName = `Xac_nhan_dat_hang_${order['Mã đơn hàng']}.docx`;
                        zipFiles.push({ blob, fileName });

                    } catch (error) {
                        console.error(`Error processing order ${order['ID đơn hàng']}:`, error);
                        if (error.properties && error.properties.errors) {
                            console.log('Template Error details:', error.properties.errors);
                        }
                    }
                }

                // Nếu chỉ có 1 đơn hàng được chọn, tải xuống trực tiếp
                if (zipFiles.length === 1) {
                    saveAs(zipFiles[0].blob, zipFiles[0].fileName);
                }
                // Nếu có nhiều đơn hàng, tải xuống file zip
                else if (zipFiles.length > 1) {
                    // Tải JSZip nếu cần
                    if (typeof JSZip === 'undefined') {
                        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js');
                    }

                    const zip = new JSZip();

                    // Thêm từng file vào zip
                    for (const file of zipFiles) {
                        zip.file(file.fileName, file.blob);
                    }

                    // Tạo và tải xuống file zip
                    const content = await zip.generateAsync({ type: 'blob' });
                    saveAs(content, `Xac_nhan_dat_hang_${appData.selectedOrders.size}_don.zip`);
                }

            } catch (error) {
                console.error('Error exporting to Word:', error);
                alert(`Lỗi khi xuất Word: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Cập nhật hàm khởi tạo để sử dụng dữ liệu đã tải
        async function initializeApp() {
            try {
                showLoading();

                // Tải tất cả dữ liệu
                await fetchAllData();

                // Cập nhật dropdown khách hàng
                populateCustomerFilter();

                // Thiết lập lọc ngày mặc định (30 ngày gần nhất)
                const today = new Date();
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(today.getDate() - 30);

                document.getElementById('toDate').valueAsDate = today;
                document.getElementById('fromDate').valueAsDate = thirtyDaysAgo;

                // Khởi tạo giao diện
                renderOrderList();
                setupSearch();
                updateSelectedCount();
            } catch (error) {
                console.error('Error initializing app:', error);
                alert(`Lỗi khởi tạo ứng dụng: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Cập nhật dropdown khách hàng
        function populateCustomerFilter() {
            const customerFilter = document.getElementById('customerFilter');
            customerFilter.innerHTML = '<option value="">Tất cả khách hàng</option>';

            // Tạo mảng từ object để có thể sắp xếp
            const customersArray = Object.values(appData.customers);

            // Sắp xếp theo tên khách hàng
            customersArray.sort((a, b) =>
                a['Tên khách hàng đầy đủ'].localeCompare(b['Tên khách hàng đầy đủ'])
            );

            customersArray.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer['ID khách hàng'];
                option.textContent = customer['Tên khách hàng đầy đủ'];
                customerFilter.appendChild(option);
            });
        }

        // Initialize when document is ready
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>

</html>
